<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Çark Yönetimi — Manhattan Likit</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#1a1a1e;--bg2:#232328;--bg3:#2c2c32;--bg4:#38383f;--tx:#e5e5e7;--tx2:#a1a1a6;--tx3:#6e6e73;--gold:#c9a24e;--goldL:#d4b060;--goldDim:rgba(201,162,78,.12);--green:#34c759;--red:#ff453a;--blue:#0a84ff;--border:rgba(255,255,255,.08);--radius:14px;--shadow:0 2px 12px rgba(0,0,0,.25)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased}
.container{max-width:960px;margin:0 auto;padding:20px 16px}

/* ─── PIN Screen ─── */
#pin-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
#pin-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:48px 40px;width:380px;max-width:100%;text-align:center}
#pin-box h1{font-size:13px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:8px;font-weight:600}
#pin-box h2{font-size:24px;font-weight:800;margin-bottom:28px;color:var(--tx)}
#pin-input{width:100%;padding:14px;font-size:32px;text-align:center;letter-spacing:14px;border:2px solid var(--border);border-radius:12px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;margin-bottom:12px;transition:border-color .2s}
#pin-input:focus{border-color:var(--gold)}
#pin-err{color:var(--red);font-size:15px;min-height:22px;margin-bottom:4px}

/* ─── Header ─── */
.header{display:flex;align-items:center;justify-content:space-between;padding:16px 0 20px;border-bottom:1px solid var(--border);margin-bottom:24px}
.header-left h1{font-size:20px;font-weight:800;color:var(--goldL);letter-spacing:1px}
.header-left p{font-size:13px;color:var(--tx3);margin-top:2px}
.header-right{display:flex;gap:8px}

/* ─── Common Controls ─── */
.btn{padding:12px 22px;border:none;border-radius:10px;font-family:inherit;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--goldL));color:#fff}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(201,162,78,.3)}
.btn-sm{font-size:13px;padding:8px 14px;font-weight:600;border-radius:8px}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--tx2)}
.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

/* ─── Toggle Switch ─── */
.toggle{position:relative;width:52px;height:28px;border-radius:14px;background:var(--bg4);cursor:pointer;transition:background .25s;flex-shrink:0}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:transform .25s;box-shadow:0 1px 4px rgba(0,0,0,.3)}
.toggle.on::after{transform:translateX(24px)}

/* ─── Section ─── */
.section{margin-bottom:28px}
.section-head{font-size:15px;font-weight:700;color:var(--goldL);margin-bottom:14px;display:flex;align-items:center;gap:8px;letter-spacing:.3px}
.section-head svg{width:18px;height:18px;stroke:var(--gold);fill:none;stroke-width:2;flex-shrink:0}

/* ─── Master Toggles Row ─── */
.master-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
.master-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.master-info h3{font-size:16px;font-weight:700;color:var(--tx)}
.master-info p{font-size:12px;color:var(--tx3);margin-top:2px}
@media(max-width:640px){.master-row{grid-template-columns:1fr}}

/* ─── Segment Table ─── */
.seg-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.seg-table thead th{font-size:12px;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;padding:14px 12px;text-align:left;border-bottom:1px solid var(--border);background:var(--bg3)}
.seg-table thead th:first-child{padding-left:18px}
.seg-table thead th:last-child{text-align:center}
.seg-table tbody tr{transition:background .15s}
.seg-table tbody tr:hover{background:rgba(255,255,255,.02)}
.seg-table tbody tr.off{opacity:.4}
.seg-table tbody td{padding:14px 12px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;font-size:15px}
.seg-table tbody td:first-child{padding-left:18px}
.seg-table tbody td:last-child{text-align:center}
.seg-table tbody tr:last-child td{border-bottom:none}

.seg-color{width:14px;height:14px;border-radius:4px;display:inline-block;vertical-align:middle;margin-right:8px;flex-shrink:0}
.seg-label-cell{display:flex;align-items:center;gap:4px}
.seg-input{background:transparent;border:1px solid transparent;border-radius:6px;padding:6px 8px;color:var(--tx);font-family:inherit;font-size:15px;font-weight:600;outline:none;width:100%;transition:all .15s}
.seg-input:hover{border-color:var(--border)}
.seg-input:focus{border-color:var(--gold);background:var(--bg)}
.seg-num{width:64px;text-align:center;font-weight:800;font-size:16px}
.seg-num-sm{width:56px;text-align:center;font-size:15px}
.seg-select{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 24px 6px 8px;color:var(--tx);font-family:inherit;font-size:13px;font-weight:600;outline:none;cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23a1a1a6' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;transition:border-color .15s}
.seg-select:focus{border-color:var(--gold)}
.seg-pct{font-size:13px;color:var(--gold);font-weight:700;min-width:48px;text-align:right;white-space:nowrap}

/* ─── Donut Chart ─── */
.chart-wrap{display:flex;align-items:center;gap:24px;padding:20px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px}
.chart-svg{width:160px;height:160px;flex-shrink:0}
.chart-legend{flex:1;display:flex;flex-wrap:wrap;gap:6px 16px}
.legend-item{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--tx2)}
.legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

/* ─── Settings Grid ─── */
.settings-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
.s-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
.s-label{font-size:13px;color:var(--tx2);font-weight:600;margin-bottom:10px}
.s-val{font-size:26px;font-weight:800;color:var(--goldL);margin-bottom:2px}
.s-desc{font-size:11px;color:var(--tx3);margin-bottom:10px}
.s-ctrl select,.s-ctrl input[type=number]{padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--tx);font-family:inherit;font-size:16px;font-weight:600;outline:none;width:100%;transition:border-color .15s}
.s-ctrl select:focus,.s-ctrl input:focus{border-color:var(--gold)}
.s-ctrl select{-webkit-appearance:none;appearance:none;padding-right:32px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23a1a1a6' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;cursor:pointer}
.slider-row{display:flex;align-items:center;gap:10px;margin-top:8px}
.slider-row input[type=range]{flex:1;-webkit-appearance:none;height:6px;border-radius:3px;background:var(--bg4);outline:none}
.slider-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--gold);cursor:pointer;border:2px solid var(--bg)}
.slider-pct{font-size:16px;font-weight:800;color:var(--goldL);min-width:44px;text-align:right}

/* ─── Stats ─── */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center}
.stat-val{font-size:32px;font-weight:800;color:var(--goldL)}
.stat-label{font-size:13px;color:var(--tx3);margin-top:4px}
.recent-list{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;max-height:300px;overflow-y:auto}
.recent-item{display:flex;justify-content:space-between;align-items:center;padding:8px 4px;border-bottom:1px solid rgba(255,255,255,.04);font-size:13px}
.recent-item:last-child{border-bottom:none}

/* ─── Action Bar ─── */
.action-bar{position:sticky;bottom:0;background:linear-gradient(to top,var(--bg) 70%,transparent);padding:16px 0 20px;display:flex;gap:10px;align-items:center;z-index:10}
.save-dot{display:none;width:8px;height:8px;border-radius:50%;background:var(--gold);animation:pulse-dot 1.5s infinite;margin-left:8px}
.save-dot.show{display:inline-block}
.save-txt{display:none;font-size:13px;color:var(--gold);font-weight:600;margin-left:4px}
.save-txt.show{display:inline}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.3}}

/* ─── Segment Table ─── */

/* ─── Status Bar ─── */
.status-bar{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:20px;font-size:14px;color:var(--tx2);display:flex;align-items:center;gap:8px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse-dot 2s infinite;flex-shrink:0}

/* ─── Toast ─── */
.toast{position:fixed;top:20px;right:20px;padding:14px 24px;border-radius:10px;font-size:15px;font-weight:700;z-index:9999;transform:translateY(-20px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}
.toast-ok{background:var(--green);color:#fff}
.toast-err{background:var(--red);color:#fff}

/* ─── PIN Modal ─── */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:32px;width:400px;max-width:100%}
.modal h3{font-size:18px;font-weight:700;margin-bottom:20px;color:var(--gold)}
.modal label{font-size:13px;color:var(--tx2);margin-bottom:6px;display:block;font-weight:600}
.modal input[type=text],.modal input[type=password]{width:100%;padding:14px;font-size:26px;text-align:center;letter-spacing:12px;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;transition:border-color .2s}
.modal input:focus{border-color:var(--gold)}
.modal-err{color:var(--red);font-size:14px;min-height:20px;margin-bottom:10px;text-align:center}
.modal-btns{display:flex;gap:10px}
.modal-btns .btn{flex:1;justify-content:center}

/* ─── Responsive ─── */
@media(max-width:768px){
  .settings-grid{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:1fr}
  .chart-wrap{flex-direction:column;align-items:center}
  .seg-table{font-size:13px}
  .seg-table thead th{font-size:11px;padding:10px 8px}
  .seg-table tbody td{padding:10px 8px}
  .seg-input{font-size:13px;padding:5px 6px}
  .seg-num{width:52px;font-size:14px}
  .seg-num-sm{width:48px;font-size:13px}
  .action-bar{flex-wrap:wrap}
  .btn{width:100%;justify-content:center}
  .header{flex-direction:column;gap:12px;align-items:flex-start}
}
@media(max-width:480px){
  .seg-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
}
</style>
</head>
<body>

<!-- PIN Screen -->
<div id="pin-screen">
  <div id="pin-box">
    <h1>Manhattan Likit</h1>
    <h2>Çark Yönetimi</h2>
    <input type="password" id="pin-input" maxlength="4" pattern="\d{4}" inputmode="numeric" autofocus placeholder="● ● ● ●" onkeydown="if(event.key==='Enter')verifyPin()">
    <div id="pin-err"></div>
    <button class="btn btn-gold" onclick="verifyPin()" style="width:100%;justify-content:center;font-size:18px;padding:16px;margin-top:4px">Giriş</button>
  </div>
</div>

<!-- Main App -->
<div id="app" style="display:none">
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>Çark Yönetimi</h1>
        <p>Ödül ayarları, oranlar ve istatistikler</p>
      </div>
      <div class="header-right">
        <button class="btn btn-outline btn-sm" onclick="showPinChange()" title="PIN Değiştir">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
          PIN
        </button>
        <button class="btn btn-outline btn-sm" onclick="loadStats()" title="Yenile">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 105.64-11.36L1 10"/></svg>
        </button>
      </div>
    </div>

    <!-- Status -->
    <div class="status-bar" id="status-bar">
      <div class="status-dot"></div>
      Yükleniyor...
    </div>

    <!-- Master Toggles -->
    <div class="master-row">
      <div class="master-card">
        <div class="master-info">
          <h3>Kupon Oluşturma</h3>
          <p>Kapalıyken kupon kodu üretilmez</p>
        </div>
        <div class="toggle on" id="tgl-coupon" onclick="toggleMaster('coupon')"></div>
      </div>
      <div class="master-card">
        <div class="master-info">
          <h3>Test Modu</h3>
          <p>Açıkken cooldown devre dışı</p>
        </div>
        <div class="toggle" id="tgl-test" onclick="toggleMaster('test')"></div>
      </div>
    </div>


    <!-- Segment Table -->
    <div class="section">
      <div class="section-head">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15 15 0 010 20M12 2a15 15 0 000 20M2 12h20"/></svg>
        Çark Dilimleri
        <span style="font-size:11px;color:var(--tx3);font-weight:400;margin-left:4px">(ağırlık = olasılık oranı)</span>
      </div>
      <div class="seg-table-wrap">
        <table class="seg-table">
          <thead>
            <tr>
              <th style="width:28%">Dilim Adı</th>
              <th style="width:13%">Tür</th>
              <th style="width:12%">İndirim</th>
              <th style="width:12%">Ağırlık</th>
              <th style="width:12%">Olasılık</th>
              <th style="width:10%">Aktif</th>
            </tr>
          </thead>
          <tbody id="seg-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-wrap" id="chart-wrap">
      <svg class="chart-svg" id="donut-chart" viewBox="0 0 200 200"></svg>
      <div class="chart-legend" id="chart-legend"></div>
    </div>

    <!-- Settings -->
    <div class="section">
      <div class="section-head">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Genel Ayarlar
      </div>
      <div class="settings-grid">
        <div class="s-card">
          <div class="s-label">Bekleme Süresi</div>
          <div class="s-val" id="cd-val">24s</div>
          <div class="s-desc">Her müşteri bu kadar bekler</div>
          <div class="s-ctrl">
            <select id="cd-select" onchange="onCdChange()">
              <option value="0.5">30 dakika</option>
              <option value="1">1 saat</option>
              <option value="2">2 saat</option>
              <option value="6">6 saat</option>
              <option value="12">12 saat</option>
              <option value="24" selected>24 saat</option>
              <option value="48">2 gün</option>
              <option value="72">3 gün</option>
              <option value="168">7 gün</option>
              <option value="336">14 gün</option>
            </select>
          </div>
        </div>
        <div class="s-card">
          <div class="s-label">Kupon Geçerlilik</div>
          <div class="s-val" id="cpn-val">7g</div>
          <div class="s-desc">Kupon sona erme süresi</div>
          <div class="s-ctrl">
            <select id="cpn-select" onchange="onCpnChange()">
              <option value="1">1 gün</option>
              <option value="3">3 gün</option>
              <option value="7" selected>7 gün</option>
              <option value="14">14 gün</option>
              <option value="30">30 gün</option>
            </select>
          </div>
        </div>
        <div class="s-card">
          <div class="s-label">Az Kalsın Efekti</div>
          <div class="s-val" id="nm-val">%40</div>
          <div class="s-desc">"Az kalsın!" hissi olasılığı</div>
          <div class="slider-row">
            <input type="range" id="nm-slider" min="0" max="80" value="40" oninput="onNmChange()">
            <span class="slider-pct" id="nm-pct">%40</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="section">
      <div class="section-head">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
        İstatistikler
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-val" id="s-total">—</div><div class="stat-label">Toplam Çevirme</div></div>
        <div class="stat-card"><div class="stat-val" id="s-7d">—</div><div class="stat-label">Son 7 Gün</div></div>
        <div class="stat-card"><div class="stat-val" id="s-30d">—</div><div class="stat-label">Son 30 Gün</div></div>
      </div>
      <div class="recent-list" id="recent-list">
        <div style="color:var(--tx3);text-align:center;padding:20px">Yükleniyor...</div>
      </div>
    </div>

    <div style="text-align:center;padding:20px 0;font-size:12px;color:var(--tx3)">Manhattan Likit — Çark Yönetim Paneli</div>
  </div>

  <!-- Sticky Action Bar -->
  <div class="action-bar">
    <div class="container" style="display:flex;gap:10px;align-items:center;padding-top:0;padding-bottom:0">
      <button class="btn btn-gold" id="save-btn" onclick="saveConfig()" style="flex-shrink:0">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Kaydet
      </button>
      <button class="btn btn-outline" onclick="loadConfig()" style="flex-shrink:0;font-size:14px;padding:10px 16px">Sıfırla</button>
      <span class="save-dot" id="save-dot"></span>
      <span class="save-txt" id="save-txt">Kaydedilmemiş değişiklik</span>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- PIN Değiştir Modal -->
<div class="modal-ov" id="pin-modal" style="display:none" onclick="if(event.target===this)closePinModal()">
  <div class="modal">
    <h3>PIN Değiştir</h3>
    <div style="margin-bottom:14px">
      <label>Yeni PIN (4 haneli)</label>
      <input type="text" id="new-pin" maxlength="4" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    </div>
    <div style="margin-bottom:14px">
      <label>Tekrar girin</label>
      <input type="text" id="confirm-pin" maxlength="4" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    </div>
    <div class="modal-err" id="pin-change-err"></div>
    <div class="modal-btns">
      <button class="btn btn-gold" onclick="doChangePin()">Değiştir</button>
      <button class="btn btn-outline" onclick="closePinModal()">Vazgeç</button>
    </div>
  </div>
</div>

<script>
var GAS_URL='https://script.google.com/macros/s/AKfycbxJKzibWzYOmapPvghMPxbt9u5vjGQyxCXZae4FKfUEsjCMIWEqkyI2CM_CovOGrzTbXQ/exec';
var PIN='';
var CFG=null;
var _dirty=false;
var _loading=false;

window.addEventListener('beforeunload',function(e){
  if(_dirty){e.preventDefault();e.returnValue='';}
});

var SEG_COLORS=['#d4b05e','#ff453a','#7eb8da','#5ec4a0','#e8c36a','#888','#ffc857','#b08ed4','#f472b6','#60a5fa','#a78bfa','#34d399'];
var TYPE_LABELS={'percent':'İndirim','shipping':'Kargo','grand':'Hediye','none':'Boş'};

// ─── PIN ───
async function verifyPin(){
  var p=document.getElementById('pin-input').value.trim();
  if(p.length!==4){document.getElementById('pin-err').textContent='4 haneli PIN girin';return}
  try{
    var r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:'kargoVerifyPin',pin:p})});
    var d=await r.json();
    if(d.ok){
      PIN=p;
      document.getElementById('pin-screen').style.display='none';
      document.getElementById('app').style.display='block';
      loadConfig();
      loadStats();
    }else{
      document.getElementById('pin-err').textContent='Yanlış PIN';
      document.getElementById('pin-input').value='';
      document.getElementById('pin-input').focus();
    }
  }catch(e){document.getElementById('pin-err').textContent='Bağlantı hatası';}
}

async function gasPost(body){
  body.pin=PIN;
  var r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify(body)});
  return await r.json();
}

// ─── CONFIG LOAD ───
async function loadConfig(){
  try{
    setStatus('Ayarlar yükleniyor...');
    var d=await gasPost({action:'spinGetConfig'});
    if(!d.ok){toast('Hata: '+(d.error||'Bilinmeyen'),'err');return}
    CFG=d.config;
    // Ensure new fields have defaults
    if(CFG.couponCreationEnabled===undefined) CFG.couponCreationEnabled=true;
    if(CFG.testMode===undefined) CFG.testMode=false;
    _loading=true;
    renderSegments();
    renderSettings();
    renderToggles();
    renderChart();
    _loading=false;
    _dirty=false;
    markClean();
    setStatus('Ayarlar yüklendi — '+CFG.segments.length+' dilim');
  }catch(e){toast('Bağlantı hatası','err')}
}

// ─── CONFIG SAVE ───
async function saveConfig(){
  if(!CFG)return;
  var btn=document.getElementById('save-btn');
  btn.disabled=true;btn.textContent='Kaydediliyor...';
  try{
    readAllFromUI();
    // Validation
    var activeCount=0;
    for(var i=0;i<CFG.segments.length;i++){
      if(CFG.segments[i].active!==false&&CFG.segments[i].weight>0) activeCount++;
    }
    if(activeCount===0){toast('En az 1 aktif dilim olmalı','err');btn.disabled=false;restoreSaveBtn();return}

    var d=await gasPost({action:'spinSaveConfig',config:CFG});
    if(d.ok){
      toast('Ayarlar kaydedildi','ok');
      _dirty=false;markClean();
    }else{
      toast('Hata: '+(d.error||'Bilinmeyen'),'err');
    }
  }catch(e){toast('Kayıt hatası','err')}
  btn.disabled=false;restoreSaveBtn();
}

function restoreSaveBtn(){
  document.getElementById('save-btn').innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Kaydet';
}

function readAllFromUI(){
  // Settings
  CFG.cooldownHours=parseFloat(document.getElementById('cd-select').value);
  CFG.couponValidityDays=parseInt(document.getElementById('cpn-select').value);
  CFG.nearMissChance=parseInt(document.getElementById('nm-slider').value)/100;
  // Segments — read from table inputs
  var rows=document.querySelectorAll('#seg-tbody tr');
  rows.forEach(function(row,i){
    if(i>=CFG.segments.length)return;
    var seg=CFG.segments[i];
    seg.label=row.querySelector('.seg-label-input').value.trim()||seg.label;
    seg.type=row.querySelector('.seg-type-select').value;
    seg.discount=parseFloat(row.querySelector('.seg-discount-input').value)||0;
    seg.weight=Math.max(0,Math.min(100,parseInt(row.querySelector('.seg-weight-input').value)||0));
  });
}

// ─── RENDER SEGMENTS ───
function renderSegments(){
  var tbody=document.getElementById('seg-tbody');
  tbody.innerHTML='';
  CFG.segments.forEach(function(seg,i){
    var isOff=seg.active===false;
    var tr=document.createElement('tr');
    if(isOff) tr.className='off';
    tr.innerHTML=
      '<td><div class="seg-label-cell"><span class="seg-color" style="background:'+SEG_COLORS[i%SEG_COLORS.length]+'"></span><input class="seg-input seg-label-input" type="text" value="'+escHtml(seg.label)+'" onchange="markDirty()" onclick="this.select()"></div></td>'+
      '<td><select class="seg-select seg-type-select" onchange="onTypeChange('+i+',this);markDirty()">'+
        '<option value="percent"'+(seg.type==='percent'?' selected':'')+'>İndirim</option>'+
        '<option value="shipping"'+(seg.type==='shipping'?' selected':'')+'>Kargo</option>'+
        '<option value="grand"'+(seg.type==='grand'?' selected':'')+'>Hediye</option>'+
        '<option value="none"'+(seg.type==='none'?' selected':'')+'>Boş</option>'+
      '</select></td>'+
      '<td><input class="seg-input seg-num-sm seg-discount-input" type="number" min="0" max="100" value="'+(seg.discount||0)+'" onchange="markDirty()" onclick="this.select()"'+(seg.type==='shipping'||seg.type==='none'||seg.type==='grand'?' disabled style="opacity:.3"':'')+'><span style="font-size:12px;color:var(--tx3)">%</span></td>'+
      '<td><input class="seg-input seg-num seg-weight-input" type="number" min="0" max="100" value="'+seg.weight+'" onchange="onWeightChange()" onclick="this.select()"></td>'+
      '<td class="seg-pct-cell"><span class="seg-pct">'+calcPct(i)+'</span></td>'+
      '<td><div class="toggle'+(isOff?'':' on')+'" onclick="toggleSeg('+i+')"></div></td>';
    tbody.appendChild(tr);
  });
}

function onTypeChange(i,sel){
  var v=sel.value;
  var row=sel.closest('tr');
  var discInput=row.querySelector('.seg-discount-input');
  if(v==='shipping'||v==='none'||v==='grand'){
    discInput.disabled=true;discInput.style.opacity='.3';
    if(v==='shipping'||v==='none') discInput.value='0';
  }else{
    discInput.disabled=false;discInput.style.opacity='1';
  }
}

function calcPct(idx){
  var total=0;
  CFG.segments.forEach(function(s){if(s.active!==false)total+=s.weight});
  if(total===0)return'%0';
  var seg=CFG.segments[idx];
  if(seg.active===false)return'%0';
  return'%'+(seg.weight/total*100).toFixed(1);
}

function updateAllPcts(){
  var cells=document.querySelectorAll('.seg-pct-cell .seg-pct');
  CFG.segments.forEach(function(_,i){
    if(cells[i]) cells[i].textContent=calcPct(i);
  });
  renderChart();
}

function onWeightChange(){
  // Read current weight values from inputs into CFG
  var inputs=document.querySelectorAll('.seg-weight-input');
  inputs.forEach(function(inp,i){
    if(i<CFG.segments.length) CFG.segments[i].weight=Math.max(0,Math.min(100,parseInt(inp.value)||0));
  });
  updateAllPcts();
  markDirty();
}

function toggleSeg(i){
  CFG.segments[i].active=CFG.segments[i].active===false?true:false;
  renderSegments();
  updateAllPcts();
  markDirty();
}

// ─── MASTER TOGGLES ───
function renderToggles(){
  var couponEl=document.getElementById('tgl-coupon');
  var testEl=document.getElementById('tgl-test');
  if(CFG.couponCreationEnabled===false){couponEl.classList.remove('on')}else{couponEl.classList.add('on')}
  if(CFG.testMode===true){testEl.classList.add('on')}else{testEl.classList.remove('on')}
}

function toggleMaster(which){
  if(which==='coupon'){
    CFG.couponCreationEnabled=!CFG.couponCreationEnabled;
    var el=document.getElementById('tgl-coupon');
    el.classList.toggle('on');
  }else if(which==='test'){
    CFG.testMode=!CFG.testMode;
    var el=document.getElementById('tgl-test');
    el.classList.toggle('on');
  }
  markDirty();
}

// ─── DONUT CHART ───
function renderChart(){
  var svg=document.getElementById('donut-chart');
  var legend=document.getElementById('chart-legend');
  svg.innerHTML='';legend.innerHTML='';
  
  var total=0;
  CFG.segments.forEach(function(s){if(s.active!==false)total+=s.weight});
  if(total===0){svg.innerHTML='<text x="100" y="105" text-anchor="middle" fill="#6e6e73" font-size="14">Aktif dilim yok</text>';return}
  
  var cx=100,cy=100,r=80,ir=50;
  var angle=-90;
  
  CFG.segments.forEach(function(seg,i){
    if(seg.active===false||seg.weight===0)return;
    var pct=seg.weight/total;
    var color=SEG_COLORS[i%SEG_COLORS.length];
    
    if(pct>=0.9999){
      var circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx',cx);circle.setAttribute('cy',cy);circle.setAttribute('r',(r+ir)/2);
      circle.setAttribute('fill','none');circle.setAttribute('stroke',color);
      circle.setAttribute('stroke-width',r-ir);circle.setAttribute('opacity','0.85');
      svg.appendChild(circle);
      angle+=360;
      legend.innerHTML+='<div class="legend-item"><span class="legend-dot" style="background:'+color+'"></span>'+escHtml(seg.label)+' <b>100%</b></div>';
      return;
    }
    
    var a1=angle*Math.PI/180;
    var a2=(angle+pct*360)*Math.PI/180;
    var large=pct>0.5?1:0;
    var x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
    var x2=cx+r*Math.cos(a2),y2=cy+r*Math.sin(a2);
    var ix1=cx+ir*Math.cos(a2),iy1=cy+ir*Math.sin(a2);
    var ix2=cx+ir*Math.cos(a1),iy2=cy+ir*Math.sin(a1);
    
    var path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d','M '+x1+' '+y1+' A '+r+' '+r+' 0 '+large+' 1 '+x2+' '+y2+' L '+ix1+' '+iy1+' A '+ir+' '+ir+' 0 '+large+' 0 '+ix2+' '+iy2+' Z');
    path.setAttribute('fill',color);path.setAttribute('opacity','0.85');
    path.setAttribute('stroke','#1a1a1e');path.setAttribute('stroke-width','2');
    svg.appendChild(path);
    angle+=pct*360;
    
    legend.innerHTML+='<div class="legend-item"><span class="legend-dot" style="background:'+color+'"></span>'+escHtml(seg.label)+' <b>'+(pct*100).toFixed(1)+'%</b></div>';
  });
  
  var ct=document.createElementNS('http://www.w3.org/2000/svg','text');
  ct.setAttribute('x','100');ct.setAttribute('y','105');
  ct.setAttribute('text-anchor','middle');ct.setAttribute('fill','#e5e5e7');
  ct.setAttribute('font-size','13');ct.setAttribute('font-weight','700');
  ct.textContent=total+' toplam';
  svg.appendChild(ct);
}

// ─── SETTINGS ───
function renderSettings(){
  var cdVal=CFG.cooldownHours||24;
  document.getElementById('cd-select').value=cdVal;
  onCdChange();
  document.getElementById('cpn-select').value=CFG.couponValidityDays||7;
  onCpnChange();
  var nm=Math.round((CFG.nearMissChance||0.4)*100);
  document.getElementById('nm-slider').value=nm;
  onNmChange();
}

function onCdChange(){
  var h=parseFloat(document.getElementById('cd-select').value);
  var txt;
  if(h<1) txt=Math.round(h*60)+'dk';
  else if(h>=24) txt=(h/24)+'g';
  else txt=h+'s';
  document.getElementById('cd-val').textContent=txt;
  markDirty();
}
function onCpnChange(){
  document.getElementById('cpn-val').textContent=document.getElementById('cpn-select').value+'g';
  markDirty();
}
function onNmChange(){
  var v=document.getElementById('nm-slider').value;
  document.getElementById('nm-val').textContent='%'+v;
  document.getElementById('nm-pct').textContent='%'+v;
  markDirty();
}

// ─── STATS ───
async function loadStats(){
  try{
    var d=await gasPost({action:'spinGetStats'});
    if(!d.ok)return;
    var s=d.stats;
    document.getElementById('s-total').textContent=s.total;
    document.getElementById('s-7d').textContent=s.last7;
    document.getElementById('s-30d').textContent=s.last30||0;
    
    var list=document.getElementById('recent-list');
    if(!s.recent||s.recent.length===0){
      list.innerHTML='<div style="color:var(--tx3);text-align:center;padding:20px">Henüz çevirme yok</div>';
      return;
    }
    list.innerHTML='';
    s.recent.forEach(function(r){
      var item=document.createElement('div');
      item.className='recent-item';
      item.innerHTML='<span style="color:var(--tx2)">'+escHtml(r.email)+'</span><span style="font-weight:700;color:var(--gold)">'+escHtml(r.prize)+'</span><span style="color:var(--tx3);font-size:12px">'+escHtml(r.date)+'</span>';
      list.appendChild(item);
    });
  }catch(e){}
}

// ─── UI HELPERS ───
function markDirty(){
  if(_loading)return;
  if(!_dirty){_dirty=true;document.getElementById('save-dot').classList.add('show');document.getElementById('save-txt').classList.add('show')}
}
function markClean(){
  document.getElementById('save-dot').classList.remove('show');
  document.getElementById('save-txt').classList.remove('show');
}
function setStatus(msg){
  document.getElementById('status-bar').innerHTML='<div class="status-dot"></div>'+msg;
}
function toast(msg,type){
  var t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast toast-'+(type||'ok')+' show';
  setTimeout(function(){t.classList.remove('show')},3000);
}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// ─── PIN DEĞİŞTİR ───
function showPinChange(){
  document.getElementById('pin-modal').style.display='flex';
  document.getElementById('new-pin').value='';
  document.getElementById('confirm-pin').value='';
  document.getElementById('pin-change-err').textContent='';
  document.getElementById('new-pin').focus();
}
function closePinModal(){
  document.getElementById('pin-modal').style.display='none';
}
async function doChangePin(){
  var np=document.getElementById('new-pin').value.trim();
  var cp=document.getElementById('confirm-pin').value.trim();
  var err=document.getElementById('pin-change-err');
  if(np.length!==4||!/^\d{4}$/.test(np)){err.textContent='4 haneli rakam girin';return}
  if(np!==cp){err.textContent='PIN\'ler eşleşmiyor';return}
  err.textContent='';
  try{
    var d=await gasPost({action:'kargoChangePin',newPin:np});
    if(d.ok){
      PIN=np;
      toast('PIN değiştirildi','ok');
      closePinModal();
    }else{
      err.textContent=d.error||'Hata oluştu';
    }
  }catch(e){err.textContent='Bağlantı hatası'}
}

// ─── HAZIR ŞABLONLAR ───
</script>
</body>
</html>
