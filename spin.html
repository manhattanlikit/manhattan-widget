<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Çark Yönetimi — Manhattan Likit</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f5f7;--bg2:#ffffff;--bg3:#e8e8ed;--bg4:#d1d1d6;--tx:#1d1d1f;--tx2:#6e6e73;--tx3:#a1a1a6;--gold:#9a7b32;--goldL:#c9a24e;--goldDim:rgba(154,123,50,.10);--green:#28a745;--red:#dc3545;--blue:#007aff;--border:rgba(0,0,0,.10);--radius:14px;--shadow:0 2px 12px rgba(0,0,0,.08)}
[data-theme="dark"]{--bg:#1a1a1e;--bg2:#232328;--bg3:#2c2c32;--bg4:#38383f;--tx:#e5e5e7;--tx2:#a1a1a6;--tx3:#6e6e73;--gold:#c9a24e;--goldL:#d4b060;--goldDim:rgba(201,162,78,.12);--green:#34c759;--red:#ff453a;--blue:#0a84ff;--border:rgba(255,255,255,.08);--shadow:0 2px 12px rgba(0,0,0,.25)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased}
.container{max-width:960px;margin:0 auto;padding:20px 16px}

/* ─── PIN Screen ─── */
#pin-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
#pin-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:48px 40px;width:380px;max-width:100%;text-align:center}
#pin-box h1{font-size:13px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:8px;font-weight:600}
#pin-box h2{font-size:24px;font-weight:800;margin-bottom:28px;color:var(--tx)}
#pin-input{width:100%;padding:14px;font-size:32px;text-align:center;letter-spacing:14px;border:2px solid var(--border);border-radius:12px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;margin-bottom:12px;transition:border-color .2s}
#pin-input:focus{border-color:var(--gold)}
#pin-err{color:var(--red);font-size:15px;min-height:22px;margin-bottom:4px}

/* ─── Header ─── */
.header{display:flex;align-items:center;justify-content:space-between;padding:16px 0 20px;border-bottom:1px solid var(--border);margin-bottom:24px}
.header-left h1{font-size:20px;font-weight:800;color:var(--goldL);letter-spacing:1px}
.header-left p{font-size:13px;color:var(--tx3);margin-top:2px}
.header-right{display:flex;gap:8px}

/* ─── Common Controls ─── */
.btn{padding:12px 22px;border:none;border-radius:10px;font-family:inherit;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--goldL));color:#fff}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(201,162,78,.3)}
.btn-sm{font-size:13px;padding:8px 14px;font-weight:600;border-radius:8px}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--tx2)}
.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

/* ─── Toggle Switch ─── */
.toggle{position:relative;width:52px;height:28px;border-radius:14px;background:var(--bg4);cursor:pointer;transition:background .25s;flex-shrink:0}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:transform .25s;box-shadow:0 1px 4px rgba(0,0,0,.3)}
.toggle.on::after{transform:translateX(24px)}

/* ─── Section ─── */
.section{margin-bottom:36px;padding-top:28px;border-top:2px solid var(--border)}
.section:first-child{border-top:none;padding-top:0}
.section-head{font-size:18px;font-weight:800;color:var(--goldL);margin-bottom:6px;display:flex;align-items:center;gap:8px;letter-spacing:.3px}
.section-head svg{width:20px;height:20px;stroke:var(--gold);fill:none;stroke-width:2;flex-shrink:0}
.section-hint{font-size:14px;color:var(--tx2);margin-bottom:18px;line-height:1.6;background:var(--goldDim);border-radius:8px;padding:10px 14px}

/* ─── Master Toggles Row ─── */
.master-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
.master-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.master-info h3{font-size:17px;font-weight:700;color:var(--tx)}
.master-info p{font-size:14px;color:var(--tx2);margin-top:4px;line-height:1.5}
@media(max-width:640px){.master-row{grid-template-columns:1fr}}

/* ─── Segment Table ─── */
.seg-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.seg-table thead th{font-size:13px;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.5px;padding:14px 12px;text-align:left;border-bottom:1px solid var(--border);background:var(--bg3)}
.seg-table thead th:first-child{padding-left:18px}
.seg-table thead th:last-child{text-align:center}
.seg-table tbody tr{transition:background .15s}
.seg-table tbody tr:hover{background:rgba(255,255,255,.02)}
.seg-table tbody tr.off{opacity:.4}
.seg-table tbody td{padding:14px 12px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;font-size:15px}
.seg-table tbody td:first-child{padding-left:18px}
.seg-table tbody td:last-child{text-align:center}
.seg-table tbody tr:last-child td{border-bottom:none}

.seg-color{width:14px;height:14px;border-radius:4px;display:inline-block;vertical-align:middle;margin-right:8px;flex-shrink:0}
.seg-label-cell{display:flex;align-items:center;gap:4px}
.seg-input{background:transparent;border:1px solid transparent;border-radius:6px;padding:6px 8px;color:var(--tx);font-family:inherit;font-size:15px;font-weight:600;outline:none;width:100%;transition:all .15s}
.seg-input:hover{border-color:var(--border)}
.seg-input:focus{border-color:var(--gold);background:var(--bg)}
.seg-input.seg-sub-input{font-size:13px;color:var(--tx2);margin-top:4px;font-weight:500;background:var(--goldDim);border:1px solid rgba(154,123,50,.2);border-radius:5px}
.seg-num{width:64px;text-align:center;font-weight:800;font-size:16px}
.seg-num-sm{width:56px;text-align:center;font-size:15px}
.seg-select{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 24px 6px 8px;color:var(--tx);font-family:inherit;font-size:13px;font-weight:600;outline:none;cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23a1a1a6' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;transition:border-color .15s}
.seg-select:focus{border-color:var(--gold)}
.seg-pct{font-size:13px;color:var(--gold);font-weight:700;min-width:48px;text-align:right;white-space:nowrap}

/* ─── Donut Chart ─── */
.chart-wrap{display:flex;align-items:center;gap:24px;padding:20px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px}
.chart-svg{width:160px;height:160px;flex-shrink:0}
.chart-legend{flex:1;display:flex;flex-wrap:wrap;gap:6px 16px}
.legend-item{display:flex;align-items:center;gap:6px;font-size:14px;color:var(--tx2);font-weight:500}
.legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

/* ─── Settings Grid ─── */
.settings-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:24px}
.s-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.s-label{font-size:15px;color:var(--tx);font-weight:700;margin-bottom:10px}
.s-val{font-size:26px;font-weight:800;color:var(--goldL);margin-bottom:2px}
.s-desc{font-size:13px;color:var(--tx2);margin-bottom:12px;line-height:1.5}
.s-ctrl select,.s-ctrl input[type=number]{padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--tx);font-family:inherit;font-size:16px;font-weight:600;outline:none;width:100%;transition:border-color .15s}
.s-ctrl select:focus,.s-ctrl input:focus{border-color:var(--gold)}
.s-ctrl select{-webkit-appearance:none;appearance:none;padding-right:32px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23a1a1a6' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;cursor:pointer}
.slider-row{display:flex;align-items:center;gap:10px;margin-top:8px}
.slider-row input[type=range]{flex:1;-webkit-appearance:none;height:6px;border-radius:3px;background:var(--bg4);outline:none}
.slider-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--gold);cursor:pointer;border:2px solid var(--bg)}
.slider-pct{font-size:16px;font-weight:800;color:var(--goldL);min-width:44px;text-align:right}

/* ─── Stats ─── */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center}
.stat-val{font-size:32px;font-weight:800;color:var(--goldL)}
.stat-label{font-size:14px;color:var(--tx2);margin-top:4px;font-weight:500}
.recent-list{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;max-height:300px;overflow-y:auto}
.recent-item{display:flex;justify-content:space-between;align-items:center;padding:10px 6px;border-bottom:1px solid rgba(255,255,255,.04);font-size:14px}
.recent-item:last-child{border-bottom:none}

/* ─── Action Bar ─── */
.action-bar{position:sticky;bottom:0;background:linear-gradient(to top,var(--bg) 80%,transparent);padding:18px 0 24px;display:flex;gap:10px;align-items:center;z-index:10;border-top:1px solid var(--border);transition:all .3s}
.action-bar.dirty{background:linear-gradient(to top,var(--bg) 60%,transparent);border-top:2px solid var(--goldL);box-shadow:0 -4px 24px rgba(175,140,62,.15)}
.save-dot{display:none;width:8px;height:8px;border-radius:50%;background:var(--gold);animation:pulse-dot 1.5s infinite;margin-left:8px}
.save-dot.show{display:inline-block}
.save-txt{display:none;font-size:14px;color:var(--gold);font-weight:700;margin-left:4px}
.save-txt.show{display:inline}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.3}}

/* ─── Segment Table ─── */

/* ─── Status Bar ─── */
.status-bar{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:20px;font-size:15px;color:var(--tx2);display:flex;align-items:center;gap:8px;font-weight:500}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse-dot 2s infinite;flex-shrink:0}

/* ─── Toast ─── */
.toast{position:fixed;top:20px;right:20px;padding:14px 24px;border-radius:10px;font-size:15px;font-weight:700;z-index:9999;transform:translateY(-20px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}
.toast-ok{background:var(--green);color:#fff}
.toast-err{background:var(--red);color:#fff}

/* ─── PIN Modal ─── */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:32px;width:400px;max-width:100%}
.modal h3{font-size:18px;font-weight:700;margin-bottom:20px;color:var(--gold)}
.modal label{font-size:13px;color:var(--tx2);margin-bottom:6px;display:block;font-weight:600}
.modal input[type=text],.modal input[type=password]{width:100%;padding:14px;font-size:26px;text-align:center;letter-spacing:12px;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;transition:border-color .2s}
.modal input:focus{border-color:var(--gold)}
.modal-err{color:var(--red);font-size:14px;min-height:20px;margin-bottom:10px;text-align:center}
.modal-btns{display:flex;gap:10px}
.modal-btns .btn{flex:1;justify-content:center}

/* ─── Responsive ─── */
@media(max-width:768px){
  .settings-grid{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:1fr}
  .chart-wrap{flex-direction:column;align-items:center}
  .seg-table{font-size:13px}
  .seg-table thead th{font-size:11px;padding:10px 8px}
  .seg-table tbody td{padding:10px 8px}
  .seg-input{font-size:13px;padding:5px 6px}
  .seg-num{width:52px;font-size:14px}
  .seg-num-sm{width:48px;font-size:13px}
  .action-bar{flex-wrap:wrap}
  .btn{width:100%;justify-content:center}
  .header{flex-direction:column;gap:12px;align-items:flex-start}
}
@media(max-width:480px){
  .seg-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .settings-grid{grid-template-columns:1fr}
}
/* ─── Theme Toggle ─── */
.test-banner{background:rgba(255,69,58,.1);border:2px solid rgba(255,69,58,.3);border-radius:10px;padding:14px 18px;margin-bottom:16px;font-size:15px;font-weight:700;color:var(--red);display:flex;align-items:center;gap:10px;animation:pulse-banner 2s infinite}
@keyframes pulse-banner{0%,100%{opacity:1}50%{opacity:.7}}
.theme-btn{background:var(--bg3);border:1px solid var(--border);border-radius:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.theme-btn:hover{border-color:var(--gold)}
.theme-btn svg{width:16px;height:16px;stroke:var(--tx2);fill:none;stroke-width:2}

/* ─── Sound Cards ─── */
.snd-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.snd-card{background:var(--bg2);border:2px solid var(--border);border-radius:10px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.snd-card:hover{border-color:rgba(201,162,78,.3);transform:translateY(-1px)}
.snd-card.active{border-color:var(--gold);background:var(--goldDim)}
.snd-card .snd-ico{font-size:20px;margin-bottom:6px}
.snd-card .snd-name{font-size:13px;font-weight:700;color:var(--tx)}
.snd-card .snd-desc{font-size:11px;color:var(--tx2);margin-top:3px}
.snd-play{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s}
.snd-play:hover{background:var(--gold);border-color:var(--gold)}
.snd-play svg{width:10px;height:10px;fill:var(--tx2);stroke:none}
.snd-play:hover svg{fill:#fff}
.snd-sub{font-size:14px;color:var(--tx);font-weight:700;margin-bottom:10px}
@media(max-width:768px){.snd-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:480px){.snd-grid{grid-template-columns:1fr 1fr}}

</style>
</head>
<body>

<!-- PIN Screen -->
<div id="pin-screen">
  <div id="pin-box">
    <h1>Manhattan Likit</h1>
    <h2>Çark Yönetimi</h2>
    <input type="password" id="pin-input" maxlength="4" pattern="\d{4}" inputmode="numeric" autofocus placeholder="● ● ● ●" onkeydown="if(event.key==='Enter')verifyPin()">
    <div id="pin-err"></div>
    <button class="btn btn-gold" onclick="verifyPin()" style="width:100%;justify-content:center;font-size:18px;padding:16px;margin-top:4px">Giriş</button>
  </div>
</div>

<!-- Main App -->
<div id="app" style="display:none">
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>Çark Yönetimi</h1>
        <p>Ödül ayarları, oranlar ve istatistikler</p>
      </div>
      <div class="header-right">
        <button class="theme-btn" onclick="toggleTheme()" title="Tema Değiştir" id="theme-btn">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
        </button>
        <button class="btn btn-outline btn-sm" onclick="showPinChange()" title="PIN Değiştir">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
          PIN
        </button>
        <button class="btn btn-outline btn-sm" onclick="loadStats()" title="Yenile">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 105.64-11.36L1 10"/></svg>
        </button>
      </div>
    </div>

    <!-- Status -->
    <div class="status-bar" id="status-bar">
      <div class="status-dot"></div>
      Yükleniyor...
    </div>

    <!-- Test Mode Banner -->
    <div class="test-banner" id="test-banner" style="display:none">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <span>TEST MODU AKTİF — Cooldown devre dışı, kuponlar test amaçlıdır</span>
    </div>

    <!-- Master Toggles -->
    <div class="master-row">
      <div class="master-card">
        <div class="master-info">
          <h3>Kupon Oluşturma</h3>
          <p>Kapalıyken müşteri kazansa bile kupon kodu verilmez</p>
        </div>
        <div class="toggle on" id="tgl-coupon" onclick="toggleMaster('coupon')"></div>
      </div>
      <div class="master-card">
        <div class="master-info">
          <h3>Test Modu</h3>
          <p>Açıkken bekleme süresi olmadan sınırsız test yapabilirsiniz</p>
        </div>
        <div class="toggle" id="tgl-test" onclick="toggleMaster('test')"></div>
      </div>
    </div>


    <!-- Settings -->
    <div class="section">
      <div class="section-head">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Genel Ayarlar
      </div>
      <div class="section-hint">Müşterinin çarkı ne sıklıkla çevireceği, kupon süresi ve özel efektler burada ayarlanır.</div>
      <div class="settings-grid">
        <div class="s-card">
          <div class="s-label">Bekleme Süresi</div>
          <div class="s-val" id="cd-val">30dk</div>
          <div class="s-desc">Müşteri çarkı çevirdikten sonra tekrar çevirebilmek için bu kadar bekler</div>
          <div class="s-ctrl">
            <select id="cd-select" onchange="onCdChange()">
              <option value="0.0166">1 dakika</option>
              <option value="0.0833">5 dakika</option>
              <option value="0.25">15 dakika</option>
              <option value="0.5">30 dakika</option>
              <option value="1">1 saat</option>
              <option value="2">2 saat</option>
              <option value="6">6 saat</option>
              <option value="12">12 saat</option>
              <option value="24">24 saat</option>
              <option value="48">2 gün</option>
              <option value="72">3 gün</option>
              <option value="168">7 gün</option>
              <option value="custom">Elle gir...</option>
            </select>
            <div id="cd-custom" style="display:none;margin-top:8px">
              <div style="display:flex;gap:6px;align-items:center">
                <input type="number" id="cd-custom-val" min="1" max="20160" value="30" style="flex:1" onchange="onCdCustom()">
                <select id="cd-custom-unit" style="width:auto;flex:0 0 auto" onchange="onCdCustom()">
                  <option value="min" selected>dakika</option>
                  <option value="hour">saat</option>
                  <option value="day">gün</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="s-card">
          <div class="s-label">Kupon Geçerlilik</div>
          <div class="s-val" id="cpn-val">7g</div>
          <div class="s-desc">Kazanılan kupon bu süre sonunda geçersiz olur</div>
          <div class="s-ctrl">
            <select id="cpn-select" onchange="onCpnChange()">
              <option value="1">1 gün</option>
              <option value="3">3 gün</option>
              <option value="7" selected>7 gün</option>
              <option value="14">14 gün</option>
              <option value="30">30 gün</option>
            </select>
          </div>
        </div>
        <div class="s-card">
          <div class="s-label">Yazı Boyutu</div>
          <div class="s-val" id="fs-val">1.0x</div>
          <div class="s-desc">Çark üzerindeki yazıları büyütüp küçültür</div>
          <div class="slider-row">
            <input type="range" id="fs-slider" min="50" max="200" value="100" step="10" oninput="onFsChange()">
            <span class="slider-pct" id="fs-pct">1.0x</span>
          </div>
        </div>
        <div class="s-card">
          <div class="s-label">Yazı Tipi</div>
          <div class="s-val" id="ff-val">Jakarta</div>
          <div class="s-desc">Çark dilimlerindeki yazının fontu</div>
          <div class="s-ctrl">
            <select id="ff-select" onchange="onFfChange()">
              <option value="Plus Jakarta Sans">Plus Jakarta Sans</option>
              <option value="Inter">Inter</option>
              <option value="Montserrat">Montserrat</option>
              <option value="Poppins">Poppins</option>
              <option value="system-ui">Sistem Fontu</option>
            </select>
          </div>
        </div>
        <div class="s-card">
          <div class="s-label">Satır Aralığı</div>
          <div class="s-val" id="lg-val">6</div>
          <div class="s-desc">Çark üzerindeki üst ve alt yazı arasındaki boşluk</div>
          <div class="slider-row">
            <input type="range" id="lg-slider" min="0" max="20" value="6" oninput="onLgChange()">
            <span class="slider-pct" id="lg-pct">6</span>
          </div>
        </div>
        <div class="s-card">
          <div class="s-label">Az Kalsın Efekti</div>
          <div class="s-val" id="nm-val">%40</div>
          <div class="s-desc">Çark büyük ödüle yakın durup geçerse heyecan yaratır</div>
          <div class="slider-row">
            <input type="range" id="nm-slider" min="0" max="80" value="40" oninput="onNmChange()">
            <span class="slider-pct" id="nm-pct">%40</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Segment Table -->
    <div class="section">
      <div class="section-head">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15 15 0 010 20M12 2a15 15 0 000 20M2 12h20"/></svg>
        Çark Dilimleri
      </div>
      <div class="section-hint">Her dilimde iki satır yazı var: ana metin ve alt metin. Ağırlık yüksek olan dilime düşme ihtimali daha fazladır.</div>
      <div class="seg-table-wrap">
        <table class="seg-table">
          <thead>
            <tr>
              <th style="width:28%">Çarkta Yazanlar</th>
              <th style="width:13%">Tür</th>
              <th style="width:12%">İndirim</th>
              <th style="width:12%">Ağırlık</th>
              <th style="width:12%">Olasılık</th>
              <th style="width:10%">Aktif</th>
            </tr>
          </thead>
          <tbody id="seg-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-wrap" id="chart-wrap">
      <svg class="chart-svg" id="donut-chart" viewBox="0 0 200 200"></svg>
      <div class="chart-legend" id="chart-legend"></div>
    </div>

    <!-- Ses Ayarları -->
    <div class="section">
      <div class="section-head">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>
        Ses Ayarları
      </div>
      <div class="section-hint">Çark dönerken, durunca ve ödül kazanıldığında çalacak sesler. Kartlara tıklayıp dinleyebilirsiniz.</div>
      <div class="snd-sub">Çark Dönme Sesi</div>
      <div class="snd-grid" id="tick-grid"></div>
      <div class="snd-sub">Voov Efekti</div>
      <div class="snd-grid" id="voov-grid"></div>
      <div class="snd-sub">Kutlama Sesi</div>
      <div class="snd-grid" id="celeb-grid"></div>
    </div>

    <!-- Stats -->
    <div class="section">
      <div class="section-head">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
        İstatistikler
      </div>
      <div class="section-hint">Müşterilerin çarkı kaç kez çevirdiği ve son ödüller.</div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-val" id="s-total">—</div><div class="stat-label">Toplam Çevirme</div></div>
        <div class="stat-card"><div class="stat-val" id="s-7d">—</div><div class="stat-label">Son 7 Gün</div></div>
        <div class="stat-card"><div class="stat-val" id="s-30d">—</div><div class="stat-label">Son 30 Gün</div></div>
      </div>
      <div class="recent-list" id="recent-list">
        <div style="color:var(--tx3);text-align:center;padding:20px">Yükleniyor...</div>
      </div>
    </div>

    <div style="text-align:center;padding:20px 0;font-size:12px;color:var(--tx3)">Manhattan Likit — Çark Yönetim Paneli</div>
  </div>

  <!-- Sticky Action Bar -->
  <div class="action-bar">
    <div class="container" style="display:flex;gap:10px;align-items:center;padding-top:0;padding-bottom:0">
      <button class="btn btn-gold" id="save-btn" onclick="saveConfig()" style="flex-shrink:0">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Kaydet
      </button>
      <button class="btn btn-outline" onclick="loadConfig()" style="flex-shrink:0;font-size:14px;padding:10px 16px">Sıfırla</button>
      <span class="save-dot" id="save-dot"></span>
      <span class="save-txt" id="save-txt">Kaydedilmemiş değişiklik</span>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- PIN Değiştir Modal -->
<div class="modal-ov" id="pin-modal" style="display:none" onclick="if(event.target===this)closePinModal()">
  <div class="modal">
    <h3>PIN Değiştir</h3>
    <div style="margin-bottom:14px">
      <label>Yeni PIN (4 haneli)</label>
      <input type="text" id="new-pin" maxlength="4" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    </div>
    <div style="margin-bottom:14px">
      <label>Tekrar girin</label>
      <input type="text" id="confirm-pin" maxlength="4" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    </div>
    <div class="modal-err" id="pin-change-err"></div>
    <div class="modal-btns">
      <button class="btn btn-gold" onclick="doChangePin()">Değiştir</button>
      <button class="btn btn-outline" onclick="closePinModal()">Vazgeç</button>
    </div>
  </div>
</div>

<script>
var GAS_URL='https://script.google.com/macros/s/AKfycbxJKzibWzYOmapPvghMPxbt9u5vjGQyxCXZae4FKfUEsjCMIWEqkyI2CM_CovOGrzTbXQ/exec';
var PIN='';
var CFG=null;
var _dirty=false;
var _loading=false;

window.addEventListener('beforeunload',function(e){
  if(_dirty){e.preventDefault();e.returnValue='';}
});

var SEG_COLORS=['#d4b05e','#ff453a','#7eb8da','#5ec4a0','#e8c36a','#888','#ffc857','#b08ed4','#f472b6','#60a5fa','#a78bfa','#34d399'];
var TYPE_LABELS={'percent':'İndirim','shipping':'Kargo','grand':'Hediye','none':'Boş'};

// ─── PIN ───
async function verifyPin(){
  var p=document.getElementById('pin-input').value.trim();
  if(p.length!==4){document.getElementById('pin-err').textContent='4 haneli PIN girin';return}
  try{
    var r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:'kargoVerifyPin',pin:p})});
    var d=await r.json();
    if(d.ok){
      PIN=p;
      document.getElementById('pin-screen').style.display='none';
      document.getElementById('app').style.display='block';
      loadConfig();
      loadStats();
    }else{
      document.getElementById('pin-err').textContent='Yanlış PIN';
      document.getElementById('pin-input').value='';
      document.getElementById('pin-input').focus();
    }
  }catch(e){document.getElementById('pin-err').textContent='Bağlantı hatası';}
}

async function gasPost(body){
  body.pin=PIN;
  var r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify(body)});
  return await r.json();
}

// ─── CONFIG LOAD ───
async function loadConfig(){
  try{
    setStatus('Ayarlar yükleniyor...');
    var d=await gasPost({action:'spinGetConfig'});
    if(!d.ok){toast('Hata: '+(d.error||'Bilinmeyen'),'err');return}
    CFG=d.config;
    // Ensure new fields have defaults
    if(CFG.couponCreationEnabled===undefined) CFG.couponCreationEnabled=true;
    if(CFG.testMode===undefined) CFG.testMode=false;
    _loading=true;
    renderSegments();
    renderSettings();
    renderToggles();
    renderChart();
    renderSounds();
    _loading=false;
    _dirty=false;
    markClean();
    setStatus('Ayarlar yüklendi — '+CFG.segments.length+' dilim');
  }catch(e){toast('Bağlantı hatası','err')}
}

// ─── CONFIG SAVE ───
async function saveConfig(){
  if(!CFG)return;
  var btn=document.getElementById('save-btn');
  btn.disabled=true;btn.textContent='Kaydediliyor...';
  try{
    readAllFromUI();
    // Validation
    var activeCount=0;
    for(var i=0;i<CFG.segments.length;i++){
      if(CFG.segments[i].active!==false&&CFG.segments[i].weight>0) activeCount++;
    }
    if(activeCount===0){toast('En az 1 aktif dilim olmalı','err');btn.disabled=false;restoreSaveBtn();return}

    var d=await gasPost({action:'spinSaveConfig',config:CFG});
    if(d.ok){
      toast('Ayarlar kaydedildi','ok');
      _dirty=false;markClean();
    }else{
      toast('Hata: '+(d.error||'Bilinmeyen'),'err');
    }
  }catch(e){toast('Kayıt hatası','err')}
  btn.disabled=false;restoreSaveBtn();
}

function restoreSaveBtn(){
  document.getElementById('save-btn').innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Kaydet';
}

function readAllFromUI(){
  // Settings
  CFG.cooldownHours=getCdHours();
  CFG.couponValidityDays=parseInt(document.getElementById('cpn-select').value);
  CFG.nearMissChance=parseInt(document.getElementById('nm-slider').value)/100;
  // Sound
  var activeTick=document.querySelector('#tick-grid .snd-card.active');
  var activeCeleb=document.querySelector('#celeb-grid .snd-card.active');
  var activeVoov=document.querySelector('#voov-grid .snd-card.active');
  if(activeTick){var idx=[].indexOf.call(document.querySelectorAll('#tick-grid .snd-card'),activeTick);if(idx>=0&&TICK_PRESETS[idx])CFG.tickSound=TICK_PRESETS[idx].id}
  if(activeCeleb){var idx2=[].indexOf.call(document.querySelectorAll('#celeb-grid .snd-card'),activeCeleb);if(idx2>=0&&CELEB_PRESETS[idx2])CFG.celebSound=CELEB_PRESETS[idx2].id}
  if(activeVoov){var idx3=[].indexOf.call(document.querySelectorAll('#voov-grid .snd-card'),activeVoov);if(idx3>=0&&VOOV_PRESETS[idx3])CFG.voovSound=VOOV_PRESETS[idx3].id}
  // Font scale + family + gap
  CFG.fontScale=parseInt(document.getElementById('fs-slider').value)/100;
  CFG.fontFamily=document.getElementById('ff-select').value;
  CFG.labelGap=parseInt(document.getElementById('lg-slider').value);
  // Segments — read from table inputs
  var rows=document.querySelectorAll('#seg-tbody tr');
  rows.forEach(function(row,i){
    if(i>=CFG.segments.length)return;
    var seg=CFG.segments[i];
    seg.label=row.querySelector('.seg-label-input').value.trim()||seg.label;
    seg.sub=row.querySelector('.seg-sub-input')?row.querySelector('.seg-sub-input').value.trim():(seg.sub||'');
    seg.type=row.querySelector('.seg-type-select').value;
    seg.discount=parseFloat(row.querySelector('.seg-discount-input').value)||0;
    seg.weight=Math.max(0,Math.min(100,parseInt(row.querySelector('.seg-weight-input').value)||0));
  });
}

// ─── RENDER SEGMENTS ───
function renderSegments(){
  var tbody=document.getElementById('seg-tbody');
  tbody.innerHTML='';
  CFG.segments.forEach(function(seg,i){
    var isOff=seg.active===false;
    var tr=document.createElement('tr');
    if(isOff) tr.className='off';
    tr.innerHTML=
      '<td><div class="seg-label-cell"><span class="seg-color" style="background:'+SEG_COLORS[i%SEG_COLORS.length]+'"></span><div style="flex:1"><input class="seg-input seg-label-input" type="text" value="'+escHtml(seg.label)+'" onchange="markDirty()" onclick="this.select()" placeholder="Ana metin (ör: %5)"><input class="seg-input seg-sub-input" type="text" value="'+escHtml(seg.sub||'')+'" onchange="markDirty()" onclick="this.select()" placeholder="Alt metin (ör: İNDİRİM)"></div></div></td>'+
      '<td><select class="seg-select seg-type-select" onchange="onTypeChange('+i+',this);markDirty()">'+
        '<option value="percent"'+(seg.type==='percent'?' selected':'')+'>İndirim (%)</option>'+
        '<option value="absolute"'+(seg.type==='absolute'?' selected':'')+'>Tutar İndirimi (TL)</option>'+
        '<option value="shipping"'+(seg.type==='shipping'?' selected':'')+'>Kargo</option>'+
        '<option value="grand"'+(seg.type==='grand'?' selected':'')+'>Hediye (TL)</option>'+
        '<option value="none"'+(seg.type==='none'?' selected':'')+'>Boş</option>'+
      '</select></td>'+
      '<td><input class="seg-input seg-num-sm seg-discount-input" type="number" min="0" max="10000" value="'+(seg.discount||0)+'" onchange="markDirty()" onclick="this.select()"'+(seg.type==='shipping'||seg.type==='none'?' disabled style="opacity:.3"':'')+'><span class="seg-unit-label" style="font-size:12px;color:var(--tx3)">'+((seg.type==='absolute'||seg.type==='grand')?'TL':'%')+'</span></td>'+
      '<td><input class="seg-input seg-num seg-weight-input" type="number" min="0" max="100" value="'+seg.weight+'" onchange="onWeightChange()" onclick="this.select()"></td>'+
      '<td class="seg-pct-cell"><span class="seg-pct">'+calcPct(i)+'</span></td>'+
      '<td><div class="toggle'+(isOff?'':' on')+'" onclick="toggleSeg('+i+')"></div></td>';
    tbody.appendChild(tr);
  });
}

function onTypeChange(i,sel){
  var v=sel.value;
  var row=sel.closest('tr');
  var discInput=row.querySelector('.seg-discount-input');
  var unitLabel=row.querySelector('.seg-unit-label');
  if(v==='shipping'||v==='none'){
    discInput.disabled=true;discInput.style.opacity='.3';
    discInput.value='0';
  }else{
    discInput.disabled=false;discInput.style.opacity='1';
  }
  if(unitLabel) unitLabel.textContent=(v==='absolute'||v==='grand')?'TL':'%';
}

function calcPct(idx){
  var total=0;
  CFG.segments.forEach(function(s){if(s.active!==false)total+=s.weight});
  if(total===0)return'%0';
  var seg=CFG.segments[idx];
  if(seg.active===false)return'%0';
  return'%'+(seg.weight/total*100).toFixed(1);
}

function updateAllPcts(){
  var cells=document.querySelectorAll('.seg-pct-cell .seg-pct');
  CFG.segments.forEach(function(_,i){
    if(cells[i]) cells[i].textContent=calcPct(i);
  });
  renderChart();
}

function onWeightChange(){
  // Read current weight values from inputs into CFG
  var inputs=document.querySelectorAll('.seg-weight-input');
  inputs.forEach(function(inp,i){
    if(i<CFG.segments.length) CFG.segments[i].weight=Math.max(0,Math.min(100,parseInt(inp.value)||0));
  });
  updateAllPcts();
  markDirty();
}

function toggleSeg(i){
  CFG.segments[i].active=CFG.segments[i].active===false?true:false;
  renderSegments();
  updateAllPcts();
  markDirty();
}

// ─── MASTER TOGGLES ───
function renderToggles(){
  var couponEl=document.getElementById('tgl-coupon');
  var testEl=document.getElementById('tgl-test');
  var banner=document.getElementById('test-banner');
  if(CFG.couponCreationEnabled===false){couponEl.classList.remove('on')}else{couponEl.classList.add('on')}
  if(CFG.testMode===true){testEl.classList.add('on');if(banner)banner.style.display='flex'}else{testEl.classList.remove('on');if(banner)banner.style.display='none'}
}

function toggleMaster(which){
  if(which==='coupon'){
    CFG.couponCreationEnabled=!CFG.couponCreationEnabled;
    var el=document.getElementById('tgl-coupon');
    el.classList.toggle('on');
  }else if(which==='test'){
    CFG.testMode=!CFG.testMode;
    var el=document.getElementById('tgl-test');
    el.classList.toggle('on');
    var banner=document.getElementById('test-banner');
    if(banner)banner.style.display=CFG.testMode?'flex':'none';
  }
  markDirty();
}

// ─── DONUT CHART ───
function renderChart(){
  var svg=document.getElementById('donut-chart');
  var legend=document.getElementById('chart-legend');
  svg.innerHTML='';legend.innerHTML='';
  
  var total=0;
  CFG.segments.forEach(function(s){if(s.active!==false)total+=s.weight});
  if(total===0){svg.innerHTML='<text x="100" y="105" text-anchor="middle" fill="#6e6e73" font-size="14">Aktif dilim yok</text>';return}
  
  var cx=100,cy=100,r=80,ir=50;
  var angle=-90;
  
  CFG.segments.forEach(function(seg,i){
    if(seg.active===false||seg.weight===0)return;
    var pct=seg.weight/total;
    var color=SEG_COLORS[i%SEG_COLORS.length];
    
    if(pct>=0.9999){
      var circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx',cx);circle.setAttribute('cy',cy);circle.setAttribute('r',(r+ir)/2);
      circle.setAttribute('fill','none');circle.setAttribute('stroke',color);
      circle.setAttribute('stroke-width',r-ir);circle.setAttribute('opacity','0.85');
      svg.appendChild(circle);
      angle+=360;
      legend.innerHTML+='<div class="legend-item"><span class="legend-dot" style="background:'+color+'"></span>'+escHtml(seg.label)+' <b>100%</b></div>';
      return;
    }
    
    var a1=angle*Math.PI/180;
    var a2=(angle+pct*360)*Math.PI/180;
    var large=pct>0.5?1:0;
    var x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
    var x2=cx+r*Math.cos(a2),y2=cy+r*Math.sin(a2);
    var ix1=cx+ir*Math.cos(a2),iy1=cy+ir*Math.sin(a2);
    var ix2=cx+ir*Math.cos(a1),iy2=cy+ir*Math.sin(a1);
    
    var path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d','M '+x1+' '+y1+' A '+r+' '+r+' 0 '+large+' 1 '+x2+' '+y2+' L '+ix1+' '+iy1+' A '+ir+' '+ir+' 0 '+large+' 0 '+ix2+' '+iy2+' Z');
    path.setAttribute('fill',color);path.setAttribute('opacity','0.85');
    path.setAttribute('stroke',document.documentElement.getAttribute('data-theme')==='dark'?'#1a1a1e':'#f5f5f7');path.setAttribute('stroke-width','2');
    svg.appendChild(path);
    angle+=pct*360;
    
    legend.innerHTML+='<div class="legend-item"><span class="legend-dot" style="background:'+color+'"></span>'+escHtml(seg.label)+' <b>'+(pct*100).toFixed(1)+'%</b></div>';
  });
  
  var ct=document.createElementNS('http://www.w3.org/2000/svg','text');
  ct.setAttribute('x','100');ct.setAttribute('y','105');
  ct.setAttribute('text-anchor','middle');ct.setAttribute('fill','#e5e5e7');
  ct.setAttribute('font-size','13');ct.setAttribute('font-weight','700');
  ct.textContent=total+' toplam';
  svg.appendChild(ct);
}

// ─── SETTINGS ───
function renderSettings(){
  // Cooldown — select'te yoksa custom moda geç
  var cdVal=CFG.cooldownHours||0.5;
  var sel=document.getElementById('cd-select');
  var matched=false;
  for(var i=0;i<sel.options.length;i++){
    if(sel.options[i].value!=='custom'&&Math.abs(parseFloat(sel.options[i].value)-cdVal)<0.001){
      sel.value=sel.options[i].value;matched=true;break;
    }
  }
  if(!matched){
    sel.value='custom';
    document.getElementById('cd-custom').style.display='block';
    if(cdVal>=24){document.getElementById('cd-custom-val').value=Math.round(cdVal/24);document.getElementById('cd-custom-unit').value='day'}
    else if(cdVal>=1){document.getElementById('cd-custom-val').value=Math.round(cdVal*10)/10;document.getElementById('cd-custom-unit').value='hour'}
    else{document.getElementById('cd-custom-val').value=Math.round(cdVal*60);document.getElementById('cd-custom-unit').value='min'}
  }
  document.getElementById('cd-val').textContent=formatCdText(cdVal);
  // Kupon
  document.getElementById('cpn-select').value=CFG.couponValidityDays||7;
  onCpnChange();
  // Near miss
  var nm=Math.round((CFG.nearMissChance||0.4)*100);
  document.getElementById('nm-slider').value=nm;
  onNmChange();
  // Font scale
  var fs=Math.round((CFG.fontScale||1.0)*100);
  document.getElementById('fs-slider').value=fs;
  onFsChange();
  // Font family
  var ff=CFG.fontFamily||'Plus Jakarta Sans';
  document.getElementById('ff-select').value=ff;
  onFfChange();
  // Label gap
  var lg=CFG.labelGap!==undefined?CFG.labelGap:6;
  document.getElementById('lg-slider').value=lg;
  onLgChange();
}

function onCdChange(){
  var sel=document.getElementById('cd-select');
  var cust=document.getElementById('cd-custom');
  if(sel.value==='custom'){
    cust.style.display='block';
    onCdCustom();
    return;
  }
  cust.style.display='none';
  var h=parseFloat(sel.value);
  document.getElementById('cd-val').textContent=formatCdText(h);
  markDirty();
}
function onCdCustom(){
  var v=parseFloat(document.getElementById('cd-custom-val').value)||1;
  var u=document.getElementById('cd-custom-unit').value;
  var h;
  if(u==='min') h=v/60;
  else if(u==='day') h=v*24;
  else h=v;
  h=Math.max(0.0166,Math.min(336,h));
  document.getElementById('cd-val').textContent=formatCdText(h);
  markDirty();
}
function formatCdText(h){
  if(h<1/60+0.001) return '1dk';
  if(h<1) return Math.round(h*60)+'dk';
  if(h>=24) return Math.round(h/24)+'g';
  return (Math.round(h*10)/10)+'s';
}
function getCdHours(){
  var sel=document.getElementById('cd-select');
  if(sel.value==='custom'){
    var v=parseFloat(document.getElementById('cd-custom-val').value)||1;
    var u=document.getElementById('cd-custom-unit').value;
    if(u==='min') return v/60;
    if(u==='day') return v*24;
    return v;
  }
  return parseFloat(sel.value);
}
function onCpnChange(){
  document.getElementById('cpn-val').textContent=document.getElementById('cpn-select').value+'g';
  markDirty();
}
function onNmChange(){
  var v=document.getElementById('nm-slider').value;
  document.getElementById('nm-val').textContent='%'+v;
  document.getElementById('nm-pct').textContent='%'+v;
  markDirty();
}
function onFsChange(){
  var v=parseInt(document.getElementById('fs-slider').value);
  var s=(v/100).toFixed(1);
  document.getElementById('fs-val').textContent=s+'x';
  document.getElementById('fs-pct').textContent=s+'x';
  markDirty();
}
function onFfChange(){
  var v=document.getElementById('ff-select').value;
  var short=v.replace('Plus Jakarta Sans','Jakarta').replace('system-ui','Sistem');
  document.getElementById('ff-val').textContent=short;
  markDirty();
}
function onLgChange(){
  var v=parseInt(document.getElementById('lg-slider').value);
  document.getElementById('lg-val').textContent=v;
  document.getElementById('lg-pct').textContent=v;
  markDirty();
}

// ─── STATS ───
async function loadStats(){
  try{
    var d=await gasPost({action:'spinGetStats'});
    if(!d.ok)return;
    var s=d.stats;
    document.getElementById('s-total').textContent=s.total;
    document.getElementById('s-7d').textContent=s.last7;
    document.getElementById('s-30d').textContent=s.last30||0;
    
    var list=document.getElementById('recent-list');
    if(!s.recent||s.recent.length===0){
      list.innerHTML='<div style="color:var(--tx3);text-align:center;padding:20px">Henüz çevirme yok</div>';
      return;
    }
    list.innerHTML='';
    s.recent.forEach(function(r){
      var item=document.createElement('div');
      item.className='recent-item';
      item.innerHTML='<span style="color:var(--tx2)">'+escHtml(r.email)+'</span><span style="font-weight:700;color:var(--gold)">'+escHtml(r.prize)+'</span><span style="color:var(--tx3);font-size:12px">'+escHtml(r.date)+'</span>';
      list.appendChild(item);
    });
  }catch(e){}
}

// ─── UI HELPERS ───
function markDirty(){
  if(_loading)return;
  if(!_dirty){_dirty=true;document.getElementById('save-dot').classList.add('show');document.getElementById('save-txt').classList.add('show');document.querySelector('.action-bar').classList.add('dirty')}
}
function markClean(){
  document.getElementById('save-dot').classList.remove('show');
  document.getElementById('save-txt').classList.remove('show');
  document.querySelector('.action-bar').classList.remove('dirty');
}
function setStatus(msg){
  document.getElementById('status-bar').innerHTML='<div class="status-dot"></div>'+msg;
}
function toast(msg,type){
  var t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast toast-'+(type||'ok')+' show';
  setTimeout(function(){t.classList.remove('show')},3000);
}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// ─── PIN DEĞİŞTİR ───
function showPinChange(){
  document.getElementById('pin-modal').style.display='flex';
  document.getElementById('new-pin').value='';
  document.getElementById('confirm-pin').value='';
  document.getElementById('pin-change-err').textContent='';
  document.getElementById('new-pin').focus();
}
function closePinModal(){
  document.getElementById('pin-modal').style.display='none';
}
async function doChangePin(){
  var np=document.getElementById('new-pin').value.trim();
  var cp=document.getElementById('confirm-pin').value.trim();
  var err=document.getElementById('pin-change-err');
  if(np.length!==4||!/^\d{4}$/.test(np)){err.textContent='4 haneli rakam girin';return}
  if(np!==cp){err.textContent='PIN\'ler eşleşmiyor';return}
  err.textContent='';
  try{
    var d=await gasPost({action:'kargoChangePin',newPin:np});
    if(d.ok){
      PIN=np;
      toast('PIN değiştirildi','ok');
      closePinModal();
    }else{
      err.textContent=d.error||'Hata oluştu';
    }
  }catch(e){err.textContent='Bağlantı hatası'}
}

// ─── TEMA DEĞİŞTİR ───
function toggleTheme(){
  var isDark=document.documentElement.getAttribute('data-theme')==='dark';
  if(isDark){
    document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('spin_theme','light');
    document.getElementById('theme-btn').innerHTML='<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>';
  }else{
    document.documentElement.setAttribute('data-theme','dark');
    localStorage.setItem('spin_theme','dark');
    document.getElementById('theme-btn').innerHTML='<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
  }
}
(function(){
  var t=localStorage.getItem('spin_theme');
  if(t==='dark'){
    document.documentElement.setAttribute('data-theme','dark');
    var b=document.getElementById('theme-btn');
    if(b)b.innerHTML='<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
  }
})();

// ─── SES PRESET SİSTEMİ ───
var _prevCtx=null;
function _getAudioCtx(){
  if(!_prevCtx)try{_prevCtx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}
  return _prevCtx;
}

var TICK_PRESETS=[
  {id:'soft',name:'Yumuşak',desc:'Hafif dokunuş',freq:1200,type:'sine',dur:0.05,gain:0.04},
  {id:'wood',name:'Ahşap',desc:'Sıcak ton',freq:400,type:'sine',dur:0.06,gain:0.1},
  {id:'velvet',name:'Kadife',desc:'Sıcak harmonik',freq:800,type:'sine',dur:0.065,gain:0.05,freq2:1600},
  {id:'bamboo',name:'Bambu',desc:'Organik dokunuş',freq:340,type:'triangle',dur:0.045,gain:0.09,freq2:680},
  {id:'leather',name:'Deri',desc:'Deri tık',freq:180,type:'sine',dur:0.03,gain:0.12,freq2:520},
  {id:'walnut',name:'Ceviz',desc:'Tok bas',freq:280,type:'sine',dur:0.055,gain:0.1,freq2:560},
  {id:'silk',name:'İpek',desc:'İpeksi geçiş',freq:2200,type:'sine',dur:0.07,gain:0.03,freq2:3300},
  {id:'mahogany',name:'Maun',desc:'Derin rezonans',freq:200,type:'triangle',dur:0.06,gain:0.11,freq2:400}
];

var CELEB_PRESETS=[
  {id:'sparkle',name:'Işıltı',desc:'Parlak arpej',notes:[1047,1319,1568,1319,1568,2093],dur:0.15,type:'sine'},
  {id:'royal',name:'Royal',desc:'Asil melodi',notes:[330,392,494,659,784,1047],dur:0.28,type:'triangle'},
  {id:'arcade',name:'Arcade',desc:'Oyun skoru',notes:[523,659,784,523,659,784,1047],dur:0.1,type:'square'},
  {id:'golden',name:'Altın',desc:'Altın arpej',notes:[440,554,659,880,1047,1319,1568],dur:0.2,type:'sine'},
  {id:'majestic',name:'Görkemli',desc:'Orkestra crescendo',notes:[262,330,392,523,659,784,1047,1319],dur:0.22,type:'sine'},
  {id:'luxe',name:'Lüks',desc:'Lüks çan',notes:[1568,1319,1568,2093,1568,2093,2637],dur:0.18,type:'sine'},
  {id:'victory',name:'Zafer',desc:'Zafer fanfarı',notes:[392,392,523,659,784,784,1047],dur:0.16,type:'triangle'},
  {id:'bliss',name:'Mutluluk',desc:'Rüya melodisi',notes:[659,784,988,1319,988,1319,1568],dur:0.25,type:'sine'}
];

var VOOV_PRESETS=[
  {id:'studio1',name:'Stüdyo 1',desc:'Küçük stüdyo'},
  {id:'studio2',name:'Stüdyo 2',desc:'Orta stüdyo'},
  {id:'studio3',name:'Stüdyo 3',desc:'Geniş stüdyo'},
  {id:'talkshow',name:'Talk Show',desc:'Canlı seyirci'},
  {id:'sitcom1',name:'Sitcom 1',desc:'Ev seyircisi'},
  {id:'sitcom2',name:'Sitcom 2',desc:'Komedi sahne'},
  {id:'arena',name:'Arena',desc:'Büyük salon'},
  {id:'gasp',name:'Hayret',desc:'Şaşkın tepki'},
  {id:'cheer',name:'Alkış',desc:'Coşkulu kalabalık'},
  {id:'wow',name:'Vaoov',desc:'Klasik vaov'}
];

function playTickPreview(id){
  var ctx=_getAudioCtx();if(!ctx)return;
  var p=TICK_PRESETS.find(function(x){return x.id===id});if(!p)return;
  for(var i=0;i<5;i++){
    (function(delay){
      setTimeout(function(){
        var t=ctx.currentTime;
        var o=ctx.createOscillator(),g=ctx.createGain();
        o.frequency.value=p.freq+Math.random()*80;o.type=p.type;
        o.connect(g);g.connect(ctx.destination);
        g.gain.setValueAtTime(p.gain,t);
        g.gain.exponentialRampToValueAtTime(0.001,t+p.dur);
        o.start();o.stop(t+p.dur);
        if(p.freq2){
          var o2=ctx.createOscillator(),g2=ctx.createGain();
          o2.frequency.value=p.freq2+Math.random()*60;o2.type='sine';
          o2.connect(g2);g2.connect(ctx.destination);
          g2.gain.setValueAtTime(p.gain*0.3,t);
          g2.gain.exponentialRampToValueAtTime(0.001,t+p.dur*0.8);
          o2.start();o2.stop(t+p.dur);
        }
      },delay);
    })(i*80);
  }
}

function playCelebPreview(id){
  var ctx=_getAudioCtx();if(!ctx)return;
  var p=CELEB_PRESETS.find(function(x){return x.id===id});if(!p)return;
  p.notes.forEach(function(freq,i){
    setTimeout(function(){
      var o=ctx.createOscillator(),g=ctx.createGain();
      o.frequency.value=freq;o.type=p.type;
      o.connect(g);g.connect(ctx.destination);
      g.gain.setValueAtTime(0.1,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+p.dur);
      o.start();o.stop(ctx.currentTime+p.dur);
    },i*(p.dur*1000*0.7));
  });
}

function playVoovPreview(id){
  var ctx=_getAudioCtx();if(!ctx)return;
  var presets={studio1:{pitch:0.8,crowd:12,dur:0.9,rise:0.3},studio2:{pitch:1.0,crowd:16,dur:1.1,rise:0.4},studio3:{pitch:0.7,crowd:20,dur:1.0,rise:0.25},talkshow:{pitch:0.9,crowd:24,dur:1.2,rise:0.35},sitcom1:{pitch:1.1,crowd:10,dur:0.8,rise:0.2},sitcom2:{pitch:0.85,crowd:14,dur:1.0,rise:0.3},arena:{pitch:0.6,crowd:30,dur:1.4,rise:0.5},gasp:{pitch:1.2,crowd:8,dur:0.7,rise:0.15},cheer:{pitch:0.75,crowd:22,dur:1.3,rise:0.4},wow:{pitch:0.95,crowd:18,dur:1.1,rise:0.35}};
  var p=presets[id];if(!p)return;
  var t=ctx.currentTime;
  var bufLen=ctx.sampleRate*p.dur;
  var buf=ctx.createBuffer(1,bufLen,ctx.sampleRate);
  var data=buf.getChannelData(0);
  for(var i=0;i<bufLen;i++) data[i]=(Math.random()*2-1);
  for(var v=0;v<Math.min(p.crowd,6);v++){
    var src=ctx.createBufferSource();src.buffer=buf;
    src.playbackRate.value=p.pitch+(Math.random()-.5)*.3;
    var bp=ctx.createBiquadFilter();bp.type='bandpass';bp.frequency.value=400+v*80+Math.random()*200;bp.Q.value=2+Math.random()*3;
    var bp2=ctx.createBiquadFilter();bp2.type='bandpass';bp2.frequency.value=800+v*60+Math.random()*300;bp2.Q.value=1.5+Math.random()*2;
    var env=ctx.createGain();var vG=0.04+Math.random()*0.02;
    env.gain.setValueAtTime(0,t);env.gain.linearRampToValueAtTime(vG,t+p.rise);env.gain.setValueAtTime(vG,t+p.rise+0.1);env.gain.exponentialRampToValueAtTime(0.001,t+p.dur);
    src.connect(bp);bp.connect(bp2);bp2.connect(env);env.connect(ctx.destination);
    src.start(t+Math.random()*0.08);src.stop(t+p.dur+0.1);
  }
  for(var j=0;j<3;j++){
    var osc=ctx.createOscillator();var og=ctx.createGain();osc.type='sine';
    osc.frequency.setValueAtTime(150+j*50+Math.random()*40,t);osc.frequency.linearRampToValueAtTime(250+j*60+Math.random()*50,t+p.rise);osc.frequency.linearRampToValueAtTime(180+j*40,t+p.dur);
    og.gain.setValueAtTime(0,t);og.gain.linearRampToValueAtTime(0.025,t+p.rise);og.gain.exponentialRampToValueAtTime(0.001,t+p.dur);
    osc.connect(og);og.connect(ctx.destination);osc.start(t);osc.stop(t+p.dur+0.05);
  }
}

function renderSounds(){
  var tg=document.getElementById('tick-grid');
  var cg=document.getElementById('celeb-grid');
  var vg=document.getElementById('voov-grid');
  if(!tg||!cg)return;
  var selTick=(CFG&&CFG.tickSound)||'wood';
  var selCeleb=(CFG&&CFG.celebSound)||'sparkle';
  var selVoov=(CFG&&CFG.voovSound)||'studio2';

  tg.innerHTML='';
  TICK_PRESETS.forEach(function(p){
    var card=document.createElement('div');
    card.className='snd-card'+(p.id===selTick?' active':'');
    card.innerHTML='<div class="snd-play" onclick="event.stopPropagation();playTickPreview(\''+p.id+'\')"><svg viewBox="0 0 12 12"><polygon points="3,1 10,6 3,11"/></svg></div><div class="snd-name">'+p.name+'</div><div class="snd-desc">'+p.desc+'</div>';
    card.onclick=function(){selectSound('tick',p.id,this)};
    tg.appendChild(card);
  });

  cg.innerHTML='';
  CELEB_PRESETS.forEach(function(p){
    var card=document.createElement('div');
    card.className='snd-card'+(p.id===selCeleb?' active':'');
    card.innerHTML='<div class="snd-play" onclick="event.stopPropagation();playCelebPreview(\''+p.id+'\')"><svg viewBox="0 0 12 12"><polygon points="3,1 10,6 3,11"/></svg></div><div class="snd-name">'+p.name+'</div><div class="snd-desc">'+p.desc+'</div>';
    card.onclick=function(){selectSound('celeb',p.id,this)};
    cg.appendChild(card);
  });

  if(vg){
    vg.innerHTML='';
    VOOV_PRESETS.forEach(function(p){
      var card=document.createElement('div');
      card.className='snd-card'+(p.id===selVoov?' active':'');
      card.innerHTML='<div class="snd-play" onclick="event.stopPropagation();playVoovPreview(\''+p.id+'\')"><svg viewBox="0 0 12 12"><polygon points="3,1 10,6 3,11"/></svg></div><div class="snd-name">'+p.name+'</div><div class="snd-desc">'+p.desc+'</div>';
      card.onclick=function(){selectSound('voov',p.id,this)};
      vg.appendChild(card);
    });
  }
}

function selectSound(type,id,el){
  var gridId=type==='tick'?'tick-grid':type==='celeb'?'celeb-grid':'voov-grid';
  if(type==='tick'){
    if(CFG)CFG.tickSound=id;playTickPreview(id);
  }else if(type==='celeb'){
    if(CFG)CFG.celebSound=id;playCelebPreview(id);
  }else{
    if(CFG)CFG.voovSound=id;playVoovPreview(id);
  }
  document.querySelectorAll('#'+gridId+' .snd-card').forEach(function(c){c.classList.remove('active')});
  if(el)el.classList.add('active');
  markDirty();
}

// ─── HAZIR ŞABLONLAR ───
</script>
</body>
</html>
