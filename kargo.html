<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Manhattan Likit — Kargo Yönetimi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
:root{--bg:#f5f5f7;--bg2:#ffffff;--bg3:#f0f0f2;--tx:#1d1d1f;--tx2:#6e6e73;--tx3:#86868b;--gold:#af8c3e;--goldL:#8a6d2b;--goldLL:#f0e2b8;--green:#28a745;--red:#dc3545;--blue:#007aff;--border:rgba(0,0,0,.08)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh}
.header{padding:24px 32px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px}
.header svg{width:28px;height:28px;color:var(--gold)}
.header h1{font-size:24px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--goldL)}
.header span{font-size:16px;color:var(--tx3);font-weight:400;letter-spacing:0}
.container{max-width:1000px;margin:0 auto;padding:32px 24px}
.cards{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
@media(max-width:640px){.cards{grid-template-columns:1fr}.btn{font-size:16px;padding:12px 16px;width:100%;justify-content:center}.panel{padding:16px}.teslim-box{padding:24px 20px}}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.card:hover{border-color:rgba(175,140,62,.4);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.08)}
.card.active{border-color:var(--gold);box-shadow:0 0 0 2px var(--gold)}
.card-num{font-size:15px;font-weight:700;color:var(--gold);letter-spacing:1px;margin-bottom:8px}
.card-title{font-size:26px;font-weight:700;color:var(--tx);margin-bottom:8px}
.card-desc{font-size:18px;color:var(--tx2);line-height:1.6}
.card-icon{position:absolute;right:20px;top:20px;width:36px;height:36px;border-radius:10px;background:rgba(175,140,62,.08);display:flex;align-items:center;justify-content:center}
.card-icon svg{width:18px;height:18px;stroke:var(--gold);fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round}

.panel{display:none;background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.panel.show{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.panel h3{font-size:22px;font-weight:700;color:var(--goldL);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.btn{padding:14px 28px;border:none;border-radius:10px;font-family:inherit;font-size:18px;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;text-decoration:none}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--goldL));color:#fff}
.btn-gold:hover{box-shadow:0 4px 16px rgba(175,140,62,.3);transform:translateY(-1px)}
.btn-gold:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--tx2)}
.btn-outline:hover{border-color:var(--gold);color:var(--goldL)}

.drop-zone{border:2px dashed rgba(0,0,0,.15);border-radius:12px;padding:40px;text-align:center;transition:all .2s;cursor:pointer;margin:12px 0}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--gold);background:rgba(175,140,62,.05)}
.drop-zone p{font-size:18px;color:var(--tx2)}
.drop-zone input{display:none}

.log{background:var(--bg);border-radius:10px;padding:16px;margin-top:16px;max-height:400px;overflow-y:auto;font-size:16px;line-height:2}
.log-item{display:flex;align-items:flex-start;gap:8px;padding:3px 0}
.log-ok{color:var(--green)}
.log-skip{color:var(--tx3)}
.log-err{color:var(--red)}
.log-info{color:var(--blue)}
.log-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:7px}

.stats{display:flex;gap:24px;padding:12px 0;flex-wrap:wrap}
.stat{text-align:center}
.stat-val{font-size:40px;font-weight:800;color:var(--goldL)}
.stat-label{font-size:15px;color:var(--tx3);margin-top:2px}

.table-wrap{overflow-x:auto;margin:12px 0;border-radius:10px;border:1px solid rgba(0,0,0,.08)}
.table-wrap table{width:100%;border-collapse:collapse;font-size:16px}
.table-wrap th{background:var(--bg);padding:10px 12px;text-align:left;color:var(--tx2);font-weight:600;white-space:nowrap;border-bottom:1px solid rgba(0,0,0,.08)}
.table-wrap td{padding:8px 12px;border-bottom:1px solid rgba(0,0,0,.04);color:var(--tx);white-space:nowrap}
.table-wrap tr:hover td{background:rgba(175,140,62,.04)}
.badge{display:inline-block;padding:4px 10px;border-radius:4px;font-size:13px;font-weight:600}
.badge-green{background:rgba(40,167,69,.1);color:var(--green)}
.badge-yellow{background:rgba(175,140,62,.1);color:var(--gold)}
.badge-gray{background:rgba(0,0,0,.05);color:var(--tx3)}

.progress{height:4px;background:rgba(0,0,0,.06);border-radius:2px;margin:8px 0;overflow:hidden}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--gold),var(--goldL));border-radius:2px;transition:width .3s;width:0}

.footer{text-align:center;padding:24px;font-size:15px;color:var(--tx3)}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 20px rgba(175,140,62,.3),0 0 60px rgba(175,140,62,.15)}50%{box-shadow:0 0 30px rgba(175,140,62,.6),0 0 80px rgba(175,140,62,.3)}}
@keyframes blink-border{0%,100%{border-color:var(--gold)}50%{border-color:var(--red)}}
@keyframes live-dot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
.teslim-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);z-index:9999;display:flex;justify-content:center;align-items:center}
.teslim-box{background:var(--bg2);border:3px solid var(--gold);border-radius:20px;padding:36px 40px;max-width:480px;width:90%;text-align:center;animation:pulse-glow 2s ease-in-out infinite,blink-border 1.5s ease-in-out infinite}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:var(--red);color:#fff;font-size:13px;font-weight:700;padding:4px 12px;border-radius:20px;letter-spacing:.5px}
.live-badge::before{content:'';width:8px;height:8px;background:#fff;border-radius:50%;animation:live-dot 1s ease-in-out infinite}
.teslim-mini{position:fixed;bottom:24px;right:24px;z-index:9998;background:var(--bg2);border:2px solid var(--gold);border-radius:14px;padding:12px 18px;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,.12);cursor:pointer;animation:pulse-glow 3s ease-in-out infinite;text-decoration:none;color:var(--tx);font-weight:600;font-size:15px}
</style>
</head>
<body>
<div class="header">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
<div style="flex:1"><h1>Manhattan Likit</h1><span>Kargo Yönetim Paneli</span></div>
<div id="header-right" style="display:none;align-items:center;gap:10px">
<span id="pin-user"></span>
<button onclick="togglePinModal()" style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;font-size:16px;color:var(--tx2);font-family:inherit" title="PIN Değiştir">⚙ PIN</button>
</div>
</div>

<!-- PIN SCREEN -->
<div id="pin-screen" style="display:flex;justify-content:center;align-items:center;min-height:60vh">
<div style="text-align:center;max-width:320px;width:100%;padding:24px">
<div style="width:64px;height:64px;border-radius:16px;background:rgba(175,140,62,.08);margin:0 auto 20px;display:flex;align-items:center;justify-content:center">
<svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:28px;height:28px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
</div>
<p style="font-size:22px;font-weight:600;color:var(--tx);margin-bottom:8px">Giriş Yapın</p>
<p style="font-size:16px;color:var(--tx3);margin-bottom:20px">4 haneli PIN kodunuzu girin</p>
<input type="password" id="pin-input" maxlength="4" pattern="\d{4}" inputmode="numeric" autofocus placeholder="● ● ● ●" onkeydown="if(event.key==='Enter')verifyPin()" style="width:100%;padding:14px;font-size:32px;text-align:center;letter-spacing:14px;border:2px solid var(--border);border-radius:12px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;margin-bottom:12px">
<p id="pin-msg" style="font-size:16px;margin-bottom:12px;display:none"></p>
<button id="pin-btn" class="btn btn-gold" onclick="verifyPin()" style="width:100%;justify-content:center;font-size:18px;padding:16px">Giriş</button>
</div>
</div>

<!-- MAIN SCREEN (hidden until PIN) -->
<div id="main-screen" style="display:none">
<div class="container">
<div class="cards">
<div class="card" onclick="showPanel('export')">
<div class="card-num">ADIM 1 <span style="display:inline-block;background:rgba(175,140,62,.12);color:var(--gold);font-size:15px;font-weight:700;padding:4px 10px;border-radius:6px;margin-left:8px;letter-spacing:0">09:00 – 18:00</span></div>
<div class="card-title">Siparişleri İndir</div>
<div class="card-desc">Bekleyen siparişleri Yurtiçi Kargo'ya yüklenecek Excel dosyasına dönüştürür</div>
<div style="margin-top:10px;font-size:14px;color:var(--gold);font-weight:600">▶ Buraya tıklayın</div>
<div class="card-icon"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
</div>
<div class="card" onclick="showPanel('import')">
<div class="card-num">ADIM 2 <span style="display:inline-block;background:rgba(175,140,62,.12);color:var(--gold);font-size:15px;font-weight:700;padding:4px 10px;border-radius:6px;margin-left:8px;letter-spacing:0">18:00 sonrası</span></div>
<div class="card-title">Takip Kodlarını Gir</div>
<div class="card-desc">Yurtiçi'den indirdiğiniz listeyi yükleyin, takip kodları otomatik girilsin</div>
<div style="margin-top:10px;font-size:14px;color:var(--gold);font-weight:600">▶ Buraya tıklayın</div>
<div class="card-icon"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
</div>
</div>

<!-- PANEL 1: Export -->
<div class="panel" id="panel-export">
<h3><svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Bekleyen Siparişleri İndir</h3>
<p style="font-size:18px;color:var(--tx2);margin-bottom:16px">Ecwid'den ödendi/işleme alındı durumdaki siparişleri çeker ve Yurtiçi Kargo Excel şablonuna dönüştürür.</p>
<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px">
<button class="btn btn-gold" id="btn-fetch" onclick="fetchOrders()"><span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.3);font-size:14px;font-weight:800;margin-right:6px">1</span> Siparişleri Çek</button>
<a href="https://ykss.yurticikargo.com/cargo?cargo=file+shipment" target="_blank" class="btn btn-gold"><span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.3);font-size:14px;font-weight:800;margin-right:6px">2</span> Dosyayı Yurtiçi'ye Yükle</a>
<a href="https://ykss.yurticikargo.com/cargo?cargo=delivery+list&delivery+list=active+deliveries" target="_blank" class="btn btn-gold"><span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.3);font-size:14px;font-weight:800;margin-right:6px">3</span> Teslim Listesini Onayla</a>
</div>
<div class="progress" id="prog-export"><div class="progress-bar" id="pbar-export"></div></div>
<div id="export-preview"></div>
<div class="log" id="log-export" style="display:none"></div>
</div>

<!-- PANEL 2: Import -->
<div class="panel" id="panel-import">
<h3><svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Takip Kodlarını Yükle</h3>
<p style="font-size:18px;color:var(--tx2);margin-bottom:12px">Önce aşağıdaki linkten bugünkü giden kargoları Excel olarak indirin, sonra buraya sürükleyin.</p>
<div style="text-align:center;margin-bottom:14px">
<a href="https://ykss.yurticikargo.com/onlineReports/outgoingCargo" target="_blank" class="btn btn-gold" style="text-decoration:none" id="btn-yk-report"><span style="display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,.3);font-size:13px;font-weight:800;margin-right:4px">1</span> Yurtiçi'den Giden Kargoları İndir</a>
</div>
<p style="font-size:16px;color:var(--tx3);margin-bottom:12px" id="yk-date-hint"></p>
<script>!function(){var d=new Date(),dd=('0'+d.getDate()).slice(-2),mm=('0'+(d.getMonth()+1)).slice(-2),yy=d.getFullYear(),t=dd+'.'+mm+'.'+yy;document.getElementById('yk-date-hint').innerHTML='Başlangıç ve Bitiş tarihini <b style="color:var(--tx)">'+t+'</b> yapıp Sorgula\'ya basın, sonra <b style="color:var(--tx)">Excel\'e Aktar</b>\'a tıklayın.'}()</script>
<div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()" style="min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px">
<svg viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;opacity:.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
<p>İndirdiğiniz Excel dosyasını buraya sürükleyin veya tıklayın</p>
<input type="file" id="file-input" accept=".xlsx,.xls">
</div>
<div class="progress" id="prog-import"><div class="progress-bar" id="pbar-import"></div></div>
<div id="import-preview"></div>
<div class="log" id="log-import" style="display:none"></div>
</div>

</div><!-- /container -->

<!-- PIN CHANGE MODAL -->
<div id="pin-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);z-index:999;display:none;justify-content:center;align-items:center" onclick="if(event.target===this)togglePinModal()">
<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:340px;width:90%;box-shadow:0 16px 48px rgba(0,0,0,.15)" onclick="event.stopPropagation()">
<p style="font-size:22px;font-weight:700;color:var(--tx);margin-bottom:16px">PIN Değiştir</p>
<label style="font-size:16px;color:var(--tx2);display:block;margin-bottom:6px">Mevcut PIN</label>
<input type="password" id="old-pin" maxlength="4" inputmode="numeric" placeholder="● ● ● ●" style="width:100%;padding:12px;font-size:22px;text-align:center;letter-spacing:12px;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;margin-bottom:12px">
<label style="font-size:16px;color:var(--tx2);display:block;margin-bottom:6px">Yeni PIN (4 haneli)</label>
<input type="password" id="new-pin" maxlength="4" inputmode="numeric" placeholder="● ● ● ●" style="width:100%;padding:12px;font-size:22px;text-align:center;letter-spacing:12px;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;margin-bottom:16px">
<button class="btn btn-gold" onclick="changePin()" style="width:100%;justify-content:center;font-size:14px">Kaydet</button>
</div>
</div>

</div><!-- /main-screen -->

<!-- TESLIM LISTESI POPUP -->
<div id="teslim-overlay" class="teslim-overlay" style="display:none">
<div class="teslim-box">
<div style="margin-bottom:14px"><span class="live-badge">CANLI</span></div>
<div style="font-size:40px;margin-bottom:10px">⚠️</div>
<div style="font-size:22px;font-weight:800;color:var(--red);margin-bottom:8px">TESLİM LİSTESİ ONAYLANDI MI?</div>
<div style="font-size:17px;color:var(--tx2);margin-bottom:6px;line-height:1.6">Onaylanmazsa bugünkü kargolar <b style="color:var(--red)">çıkmaz!</b></div>
<div style="font-size:15px;color:var(--tx3);margin-bottom:20px">Yurtiçi Kargo panelinden teslim listesini onaylayın.</div>
<a href="https://ykss.yurticikargo.com/cargo?cargo=delivery+list&delivery+list=active+deliveries" target="_blank" class="btn btn-gold" style="width:100%;justify-content:center;font-size:18px;padding:16px;margin-bottom:10px" onclick="teslimDismiss()">Teslim Listesini Onayla</a>
<button class="btn btn-outline" onclick="teslimDismiss()" style="width:100%;justify-content:center;font-size:16px;font-weight:700;padding:14px;color:var(--tx);border:2px solid var(--border)">Onayladım, kapat</button>
</div>
</div>

<!-- TESLIM MINI BADGE (persistent after dismiss) -->
<a id="teslim-mini" class="teslim-mini" href="https://ykss.yurticikargo.com/cargo?cargo=delivery+list&delivery+list=active+deliveries" target="_blank" style="display:none">
<span class="live-badge">CANLI</span>
Teslim Listesi
</a>

<div class="footer">Manhattan Likit · Kargo Yönetim Paneli</div>

<script>
// === CONFIG ===
const GAS_URL='https://script.google.com/macros/s/AKfycbxJKzibWzYOmapPvghMPxbt9u5vjGQyxCXZae4FKfUEsjCMIWEqkyI2CM_CovOGrzTbXQ/exec';
const YK_TRACK_URL='https://ykss.yurticikargo.com/reports/SSWDocumentDetail/';
const CARGO_DEFAULTS={
  kargoTuru:0,    // DOSYA
  odemeTipi:1,    // GÖNDERİCİ
  adet:1,
  icerik:'BODY BUTTER'
};
var SESSION_PIN=null;
// 24h session check
!function(){var s=localStorage.getItem("kargo_session");if(s){try{var d=JSON.parse(s);if(d.pin&&d.exp>Date.now()){SESSION_PIN=d.pin;document.addEventListener("DOMContentLoaded",function(){document.getElementById("pin-screen").style.display="none";document.getElementById("main-screen").style.display="block";document.getElementById("header-right").style.display="flex";document.getElementById("pin-user").textContent="Kullanıcı "+d.user})}}catch(e){}}}();
var FAIL_COUNT=0;
var LOCKED_UNTIL=0;

// === HELPERS ===
function ts(){var d=new Date();return d.getFullYear()+('0'+(d.getMonth()+1)).slice(-2)+('0'+d.getDate()).slice(-2)+'_'+('0'+d.getHours()).slice(-2)+('0'+d.getMinutes()).slice(-2)}
function normPhone(p){if(!p)return'';return String(p).replace(/\D/g,'').slice(-10)}
function log(id,msg,type){
  var el=document.getElementById(id);el.style.display='block';
  var colors={ok:'var(--green)',skip:'var(--tx3)',err:'var(--red)',info:'var(--blue)'};
  el.innerHTML+='<div class="log-item"><div class="log-dot" style="background:'+colors[type||'info']+'"></div><span class="log-'+(type||'info')+'">'+msg+'</span></div>';
  el.scrollTop=el.scrollHeight;
}
function setProgress(barId,pct){document.getElementById(barId).style.width=pct+'%'}

async function gasPost(body){
  var r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify(body)});
  var text=await r.text();
  try{return JSON.parse(text)}catch(e){return{ok:false,error:'Sunucu yanıt hatası'}}
}

// === PIN SYSTEM ===
async function verifyPin(){
  var inp=document.getElementById('pin-input');
  var pin=inp.value.trim();
  if(!pin){inp.focus();return}
  
  var now=Date.now();
  if(LOCKED_UNTIL>now){
    showPinMsg('⏳ '+Math.ceil((LOCKED_UNTIL-now)/60000)+' dakika bekleyin.',true);
    return;
  }
  
  document.getElementById('pin-btn').disabled=true;
  document.getElementById('pin-btn').textContent='Kontrol ediliyor...';
  
  var res=await gasPost({action:'kargoVerifyPin',pin:pin});
  
  if(res.ok){
    SESSION_PIN=pin;
    localStorage.setItem('kargo_session',JSON.stringify({pin:pin,user:res.user,exp:Date.now()+86400000}));
    localStorage.setItem('kargo_session',JSON.stringify({pin:pin,user:res.user,exp:Date.now()+24*60*60*1000}));
    FAIL_COUNT=0;
    document.getElementById('pin-screen').style.display='none';
    document.getElementById('main-screen').style.display='block';
    document.getElementById('header-right').style.display='flex';
    document.getElementById('pin-user').textContent='Kullanıcı '+res.user;
  }else{
    if(res.locked){
      LOCKED_UNTIL=now+5*60*1000;
      showPinMsg('⏳ Çok fazla hatalı deneme. 5 dakika bekleyin.',true);
    }else{
      FAIL_COUNT++;
      var rem=res.remaining!=null?res.remaining:(5-FAIL_COUNT);
      showPinMsg('Hatalı PIN. Kalan hak: '+rem,rem<=2);
    }
    inp.value='';inp.focus();
  }
  document.getElementById('pin-btn').disabled=false;
  document.getElementById('pin-btn').textContent='Giriş';
}

function showPinMsg(msg,isErr){
  var el=document.getElementById('pin-msg');
  el.textContent=msg;
  el.style.color=isErr?'var(--red)':'var(--tx2)';
  el.style.display='block';
}

async function changePin(){
  var oldP=document.getElementById('old-pin').value.trim();
  var newP=document.getElementById('new-pin').value.trim();
  if(!oldP||!newP){alert('Eski ve yeni PIN girin.');return}
  if(!/^\d{4}$/.test(newP)){alert('Yeni PIN 4 haneli sayı olmalı.');return}
  
  var res=await gasPost({action:'kargoChangePin',pin:oldP,newPin:newP});
  if(res.ok){
    SESSION_PIN=newP;
    var prev=JSON.parse(localStorage.getItem('kargo_session')||'{}');
    localStorage.setItem('kargo_session',JSON.stringify({pin:newP,user:prev.user||'',exp:Date.now()+86400000}));
    alert('PIN başarıyla değiştirildi.');
    document.getElementById('pin-modal').style.display='none';
    document.getElementById('old-pin').value='';
    document.getElementById('new-pin').value='';
  }else{
    alert(res.error||'Hata oluştu.');
  }
}

function togglePinModal(){
  var m=document.getElementById('pin-modal');
  m.style.display=m.style.display==='block'?'none':'block';
}

// === PANEL TOGGLE ===
function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show'));
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('show');
  event.currentTarget.classList.add('active');
}

// === BUTON 1: Siparişleri Çek → Yurtiçi Excel ===
async function fetchOrders(){
  var btn=document.getElementById('btn-fetch');
  btn.disabled=true;btn.textContent='Çekiliyor...';
  document.getElementById('log-export').innerHTML='';
  document.getElementById('export-preview').innerHTML='';
  setProgress('pbar-export',10);

  try{
    log('log-export','Ecwid siparişleri çekiliyor...','info');
    
    var res=await gasPost({action:'kargoGetOrders',pin:SESSION_PIN});
    setProgress('pbar-export',50);
    
    if(!res.ok){
      log('log-export','HATA: '+(res.error||'Bilinmeyen hata'),'err');
      btn.disabled=false;btn.textContent='Siparişleri Çek';
      return;
    }
    
    var allOrders=res.orders||[];
    
    if(allOrders.length===0){
      log('log-export','Bekleyen sipariş bulunamadı.','skip');
      btn.disabled=false;btn.textContent='Siparişleri Çek';
      setProgress('pbar-export',100);
      return;
    }

    log('log-export','Toplam '+allOrders.length+' bekleyen sipariş bulundu.','ok');

    // Build Yurtiçi template data
    var headers=['Kişi / Kurum Adı (*)','Adresi (*)','İl','İlçe','Telefon Ev/İş','Telefon Cep','E-Mail Adresi','Vergi No','Kargo Türü (*)','Ödeme Tipi (*)','İrsaliye Numarası','Referans Numarası','Adet (*)','Kargo İçeriği','Tahsilat Tipi','Fatura Numarası','Fatura Tutarı','Dosya/Poşet No','Kampanya No','Kampanya Kodu'];
    var rows=[headers];
    var preview=[];

    allOrders.forEach(function(o){
      var fullAddr=o.street;
      if(o.city&&!o.street.toUpperCase().includes(o.city.toUpperCase())){
        fullAddr+=' '+o.city;
      }

      var row=[
        o.name,                    // A: Kişi/Kurum
        fullAddr.toUpperCase(),    // B: Adres
        (o.state||'').toUpperCase(),// C: İl
        (o.city||'').toUpperCase(),// D: İlçe
        '',                        // E: Telefon Ev/İş
        normPhone(o.phone),        // F: Telefon Cep
        '',                        // G: E-Mail
        '',                        // H: Vergi No
        CARGO_DEFAULTS.kargoTuru,  // I: 0=DOSYA
        CARGO_DEFAULTS.odemeTipi,  // J: 1=GÖNDERİCİ
        '',                        // K: İrsaliye No
        '',                        // L: Referans No (boş)
        CARGO_DEFAULTS.adet,       // M: 1
        CARGO_DEFAULTS.icerik,     // N: BODY BUTTER
        '',                        // O: Tahsilat Tipi
        '',                        // P: Fatura No
        '',                        // Q: Fatura Tutarı
        '',                        // R: Dosya/Poşet No
        '',                        // S: Kampanya No
        ''                         // T: Kampanya Kodu
      ];
      rows.push(row);
      preview.push({name:o.name,state:o.state,city:o.city,phone:normPhone(o.phone),orderId:o.id,orderNum:o.orderNumber,total:o.total});
      log('log-export','#'+o.orderNumber+' · '+o.name+' · '+(o.state||'')+' / '+(o.city||'')+' · '+o.total+' ₺','ok');
    });

    setProgress('pbar-export',80);

    // Generate Excel
    var wb=XLSX.utils.book_new();
    var ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[{wch:30},{wch:50},{wch:15},{wch:15},{wch:15},{wch:15},{wch:25},{wch:12},{wch:10},{wch:10},{wch:15},{wch:15},{wch:8},{wch:15},{wch:10},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12}];
    XLSX.utils.book_append_sheet(wb,ws,'Sheet1');
    var fname='YK_Kargo_'+ts()+'.xlsx';
    XLSX.writeFile(wb,fname);
    
    setProgress('pbar-export',100);
    log('log-export','✓ '+fname+' indirildi — '+allOrders.length+' sipariş','ok');

    // Preview table
    var html='<div class="stats"><div class="stat"><div class="stat-val">'+allOrders.length+'</div><div class="stat-label">Sipariş</div></div></div>';
    html+='<div class="table-wrap"><table><tr><th>Sipariş</th><th>Müşteri</th><th>İl</th><th>İlçe</th><th>Telefon</th><th>Tutar</th></tr>';
    preview.forEach(function(p){
      html+='<tr><td>#'+p.orderNum+'</td><td>'+p.name+'</td><td>'+(p.state||'')+'</td><td>'+(p.city||'')+'</td><td>'+p.phone+'</td><td>'+(p.total||0)+' ₺</td></tr>';
    });
    html+='</table></div>';
    document.getElementById('export-preview').innerHTML=html;

  }catch(e){
    log('log-export','HATA: '+e.message,'err');
  }
  btn.disabled=false;btn.textContent='Siparişleri Çek';
}

// === BUTON 2: Results Upload → Ecwid Tracking ===
var dropZone=document.getElementById('drop-zone');
var fileInput=document.getElementById('file-input');

dropZone.addEventListener('dragover',function(e){e.preventDefault();dropZone.classList.add('dragover')});
dropZone.addEventListener('dragleave',function(){dropZone.classList.remove('dragover')});
dropZone.addEventListener('drop',function(e){e.preventDefault();dropZone.classList.remove('dragover');if(e.dataTransfer.files.length)processResults(e.dataTransfer.files[0])});
fileInput.addEventListener('change',function(){if(fileInput.files.length)processResults(fileInput.files[0])});

async function processResults(file){
  document.getElementById('log-import').innerHTML='';
  document.getElementById('import-preview').innerHTML='';
  setProgress('pbar-import',5);
  log('log-import','Dosya okunuyor: '+file.name,'info');

  try{
    var data=await file.arrayBuffer();
    var wb=XLSX.read(data);
    var ws=wb.Sheets[wb.SheetNames[0]];
    var json=XLSX.utils.sheet_to_json(ws,{defval:''});
    
    if(!json.length){log('log-import','Dosyada veri bulunamadı.','err');return}
    
    log('log-import',json.length+' satır okundu.','info');
    setProgress('pbar-import',15);

    // Find column mappings dynamically
    var cols=Object.keys(json[0]);
    var colTrack=cols.find(c=>/gönderi.*kodu|takip.*no/i.test(c))||cols[1];
    var colName=cols.find(c=>/alıcı.*müşteri$/i.test(c))||cols[3];
    var colPhone=cols.find(c=>/alıcı.*telefon/i.test(c))||cols[6];
    var colOzel1=cols.find(c=>c==='Özel Alan 1');
    var colOzel=cols.find(c=>c==='Özel Alan'&&c!=='Özel Alan 1'&&c!=='Özel Alan 2');
    var colRef=cols.find(c=>/referans/i.test(c));
    
    log('log-import','Kolon eşlemesi: Takip='+colTrack+', Ad='+colName,'info');

    // Parse results rows
    var shipments=json.map(function(r){
      var trackCode=String(r[colTrack]||'').trim();
      var name=String(r[colName]||'').trim();
      var phone=normPhone(r[colPhone]);
      var ozel1=String(r[colOzel1]||'').trim();
      var ozel=String(r[colOzel]||r[colRef]||'').trim();
      var ecwidId=ozel1||'';
      if(!ecwidId&&ozel){
        var m=ozel.match(/Müşteri Kargo Ref Kodu[:\s]*(\d+)/i)||ozel.match(/Sipariş No[:\s]*(\d+)/i);
        if(m)ecwidId=m[1];
      }
      return{trackCode:trackCode,name:name,phone:phone,ecwidId:ecwidId};
    }).filter(function(s){return s.trackCode});
    
    log('log-import',shipments.length+' geçerli gönderi bulundu.','info');
    setProgress('pbar-import',25);

    var updated=0,skipped=0,notFound=0,errors=0;
    
    for(var i=0;i<shipments.length;i++){
      var s=shipments[i];
      setProgress('pbar-import',25+Math.round(i/shipments.length*70));
      
      var orderId=null;
      var orderNum=null;
      var alreadyShipped=false;
      
      // Strategy 1: Direct match via Özel Alan
      if(s.ecwidId&&/^\d+$/.test(s.ecwidId)){
        var chk=await gasPost({action:'kargoCheckOrder',pin:SESSION_PIN,orderId:s.ecwidId});
        if(chk.ok){
          orderId=chk.id;
          orderNum=chk.orderNumber;
          if(chk.fulfillmentStatus==='SHIPPED')alreadyShipped=true;
        }
      }
      
      // Strategy 2: Phone fallback
      if(!orderId&&s.phone){
        var ph=await gasPost({action:'kargoSearchByPhone',pin:SESSION_PIN,phone:s.phone});
        if(ph.ok){
          orderId=ph.id;
          orderNum=ph.orderNumber;
          if(ph.fulfillmentStatus==='SHIPPED')alreadyShipped=true;
        }
      }
      
      // Already shipped — önceden girilmiş
      if(alreadyShipped){
        log('log-import','⏭ Kargo takibi önceden girilmiş: #'+(orderNum||orderId)+' · '+s.name,'skip');
        skipped++;
        continue;
      }
      
      // Not found at all
      if(!orderId){
        log('log-import','✗ Eşleşmedi: '+s.name+' — Farklı kargo firması (Sürat, MNG vb.) olabilir','err');
        notFound++;
        continue;
      }
      
      // Update tracking
      var upd=await gasPost({action:'kargoUpdateTracking',pin:SESSION_PIN,orderId:String(orderId),trackCode:s.trackCode});
      if(upd.ok){
        log('log-import','✓ #'+(orderNum||orderId)+' · '+s.name+' → '+s.trackCode,'ok');
        updated++;
      }else{
        log('log-import','✗ Güncelleme hatası #'+orderId+': '+(upd.error||''),'err');
        errors++;
      }
      
      await new Promise(function(r){setTimeout(r,200)});
    }
    
    setProgress('pbar-import',100);
    
    var html='<div class="stats">';
    html+='<div class="stat"><div class="stat-val" style="color:var(--green)">'+updated+'</div><div class="stat-label">Güncellendi</div></div>';
    html+='<div class="stat"><div class="stat-val" style="color:var(--tx3)">'+skipped+'</div><div class="stat-label">Atlandı (önceden girilmiş)</div></div>';
    if(notFound)html+='<div class="stat"><div class="stat-val" style="color:var(--red)">'+notFound+'</div><div class="stat-label">Eşleşmedi</div></div>';
    if(errors)html+='<div class="stat"><div class="stat-val" style="color:var(--red)">'+errors+'</div><div class="stat-label">Hata</div></div>';
    html+='</div>';
    
    log('log-import','─── Tamamlandı: '+updated+' güncellendi, '+skipped+' atlandı'+(notFound?', '+notFound+' eşleşmedi':'')+(errors?', '+errors+' hata':''),'info');
    document.getElementById('import-preview').innerHTML=html;
    
  }catch(e){
    log('log-import','HATA: '+e.message,'err');
  }
}
// === TESLİM LİSTESİ HATIRLATICI (17:15 - 17:40) ===
var teslimDismissed=false;
function teslimDismiss(){
  teslimDismissed=true;
  document.getElementById('teslim-overlay').style.display='none';
  document.getElementById('teslim-mini').style.display='flex';
}
function checkTeslimTime(){
  if(!SESSION_PIN)return;
  var now=new Date();
  var mins=now.getHours()*60+now.getMinutes();
  var overlay=document.getElementById('teslim-overlay');
  var mini=document.getElementById('teslim-mini');
  // 17:15 = 1035, 17:40 = 1060
  if(mins>=1035&&mins<=1060){
    if(!teslimDismissed){
      overlay.style.display='flex';
      mini.style.display='none';
    }else{
      overlay.style.display='none';
      mini.style.display='flex';
    }
    if(!window._teslimTitleBlink){
      window._teslimTitleBlink=setInterval(function(){
        document.title=document.title==='⚠️ TESLİM LİSTESİ!'?'Manhattan Kargo':'⚠️ TESLİM LİSTESİ!';
      },1000);
    }
  }else{
    overlay.style.display='none';
    mini.style.display='none';
    teslimDismissed=false;
    if(window._teslimTitleBlink){clearInterval(window._teslimTitleBlink);window._teslimTitleBlink=null;document.title='Manhattan Kargo'}
  }
}
setInterval(checkTeslimTime,30000);
setTimeout(checkTeslimTime,2000);

// Auto-focus PIN input
document.addEventListener("DOMContentLoaded",function(){document.getElementById("pin-input").focus()});
</script>
</body>
</html>
