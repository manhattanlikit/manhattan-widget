<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Manhattan Likit — Kargo Yönetimi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
:root{--bg:#f5f5f7;--bg2:#ffffff;--bg3:#f0f0f2;--tx:#1d1d1f;--tx2:#6e6e73;--tx3:#86868b;--gold:#af8c3e;--goldL:#8a6d2b;--goldLL:#f0e2b8;--green:#28a745;--red:#dc3545;--blue:#007aff;--border:rgba(0,0,0,.08)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh}
.header{padding:24px 32px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px}
.header svg{width:28px;height:28px;color:var(--gold)}
.header h1{font-size:24px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--goldL)}
.header span{font-size:16px;color:var(--tx3);font-weight:400;letter-spacing:0}
.container{max-width:1000px;margin:0 auto;padding:32px 24px}
.cards{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px}
@media(max-width:640px){.cards{grid-template-columns:1fr}.btn{font-size:16px;padding:12px 16px;width:100%;justify-content:center}.panel{padding:16px}.teslim-box{padding:24px 20px}}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.card:hover{border-color:rgba(175,140,62,.4);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.08)}
.card.active{border-color:var(--gold);box-shadow:0 0 0 2px var(--gold)}
.card-num{font-size:15px;font-weight:700;color:var(--gold);letter-spacing:1px;margin-bottom:8px}
.card-title{font-size:26px;font-weight:700;color:var(--tx);margin-bottom:8px}
.card-desc{font-size:18px;color:var(--tx2);line-height:1.6}
.card-icon{position:absolute;right:20px;top:20px;width:36px;height:36px;border-radius:10px;background:rgba(175,140,62,.08);display:flex;align-items:center;justify-content:center}
.card-icon svg{width:18px;height:18px;stroke:var(--gold);fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round}

.panel{display:none;background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.panel.show{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.panel h3{font-size:22px;font-weight:700;color:var(--goldL);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.btn{padding:14px 28px;border:none;border-radius:10px;font-family:inherit;font-size:18px;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;text-decoration:none}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--goldL));color:#fff}
.btn-gold:hover{box-shadow:0 4px 16px rgba(175,140,62,.3);transform:translateY(-1px)}
.btn-gold:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--tx2)}
.btn-outline:hover{border-color:var(--gold);color:var(--goldL)}

.drop-zone{border:2px dashed rgba(0,0,0,.15);border-radius:12px;padding:40px;text-align:center;transition:all .2s;cursor:pointer;margin:12px 0}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--gold);background:rgba(175,140,62,.05)}
.drop-zone p{font-size:18px;color:var(--tx2)}
.drop-zone input{display:none}

.log{background:var(--bg);border-radius:10px;padding:16px;margin-top:16px;max-height:400px;overflow-y:auto;font-size:16px;line-height:2}
.log-item{display:flex;align-items:flex-start;gap:8px;padding:3px 0}
.log-ok{color:var(--green)}
.log-skip{color:var(--tx3)}
.log-err{color:var(--red)}
.log-info{color:var(--blue)}
.log-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:7px}

.stats{display:flex;gap:24px;padding:12px 0;flex-wrap:wrap}
.stat{text-align:center}
.stat-val{font-size:40px;font-weight:800;color:var(--goldL)}
.stat-label{font-size:15px;color:var(--tx3);margin-top:2px}

.table-wrap{overflow-x:auto;margin:12px 0;border-radius:10px;border:1px solid rgba(0,0,0,.08)}
.table-wrap table{width:100%;border-collapse:collapse;font-size:16px}
.table-wrap th{background:var(--bg);padding:10px 12px;text-align:left;color:var(--tx2);font-weight:600;white-space:nowrap;border-bottom:1px solid rgba(0,0,0,.08)}
.table-wrap td{padding:8px 12px;border-bottom:1px solid rgba(0,0,0,.04);color:var(--tx);white-space:nowrap}
.table-wrap tr:hover td{background:rgba(175,140,62,.04)}
.badge{display:inline-block;padding:4px 10px;border-radius:4px;font-size:13px;font-weight:600}
.badge-green{background:rgba(40,167,69,.1);color:var(--green)}
.badge-yellow{background:rgba(175,140,62,.1);color:var(--gold)}
.badge-gray{background:rgba(0,0,0,.05);color:var(--tx3)}

.progress{height:4px;background:rgba(0,0,0,.06);border-radius:2px;margin:8px 0;overflow:hidden}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--gold),var(--goldL));border-radius:2px;transition:width .3s;width:0}

.footer{text-align:center;padding:24px;font-size:15px;color:var(--tx3)}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 20px rgba(175,140,62,.3),0 0 60px rgba(175,140,62,.15)}50%{box-shadow:0 0 30px rgba(175,140,62,.6),0 0 80px rgba(175,140,62,.3)}}
@keyframes blink-border{0%,100%{border-color:var(--gold)}50%{border-color:var(--red)}}
@keyframes live-dot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
.teslim-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);z-index:9999;display:flex;justify-content:center;align-items:center}
.teslim-box{background:var(--bg2);border:3px solid var(--gold);border-radius:20px;padding:36px 40px;max-width:480px;width:90%;text-align:center;animation:pulse-glow 2s ease-in-out infinite,blink-border 1.5s ease-in-out infinite}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:var(--red);color:#fff;font-size:13px;font-weight:700;padding:4px 12px;border-radius:20px;letter-spacing:.5px}
.live-badge::before{content:'';width:8px;height:8px;background:#fff;border-radius:50%;animation:live-dot 1s ease-in-out infinite}
.teslim-mini{position:fixed;bottom:24px;right:24px;z-index:9998;background:var(--bg2);border:2px solid var(--gold);border-radius:14px;padding:12px 18px;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,.12);cursor:pointer;animation:pulse-glow 3s ease-in-out infinite;text-decoration:none;color:var(--tx);font-weight:600;font-size:15px}
#auto-slider:before{position:absolute;content:"";height:26px;width:26px;left:3px;bottom:3px;background-color:#fff;border-radius:50%;transition:.3s}
#auto-toggle:checked+#auto-slider{background-color:var(--green)}
#auto-toggle:checked+#auto-slider:before{transform:translateX(28px)}
</style>
</head>
<body>
<div class="header">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
<div style="flex:1"><h1>Manhattan Likit</h1><span>Kargo Yönetim Paneli</span></div>
<div id="header-right" style="display:none;align-items:center;gap:10px">
<span id="pin-user"></span>
<button onclick="togglePinModal()" style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;font-size:16px;color:var(--tx2);font-family:inherit" title="PIN Değiştir">⚙ PIN</button>
</div>
</div>

<!-- PIN SCREEN -->
<div id="pin-screen" style="display:flex;justify-content:center;align-items:center;min-height:60vh">
<div style="text-align:center;max-width:320px;width:100%;padding:24px">
<div style="width:64px;height:64px;border-radius:16px;background:rgba(175,140,62,.08);margin:0 auto 20px;display:flex;align-items:center;justify-content:center">
<svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:28px;height:28px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
</div>
<p style="font-size:22px;font-weight:600;color:var(--tx);margin-bottom:8px">Giriş Yapın</p>
<p style="font-size:16px;color:var(--tx3);margin-bottom:20px">4 haneli PIN kodunuzu girin</p>
<input type="password" id="pin-input" maxlength="4" pattern="\d{4}" inputmode="numeric" autofocus placeholder="● ● ● ●" onkeydown="if(event.key==='Enter')verifyPin()" style="width:100%;padding:14px;font-size:32px;text-align:center;letter-spacing:14px;border:2px solid var(--border);border-radius:12px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;margin-bottom:12px">
<p id="pin-msg" style="font-size:16px;margin-bottom:12px;display:none"></p>
<button id="pin-btn" class="btn btn-gold" onclick="verifyPin()" style="width:100%;justify-content:center;font-size:18px;padding:16px">Giriş</button>
</div>
</div>

<!-- MAIN SCREEN (hidden until PIN) -->
<div id="main-screen" style="display:none">
<div class="container">
<div class="cards">
<div class="card" onclick="showPanel('export')">
<div class="card-num">ADIM 1 <span style="display:inline-block;background:rgba(175,140,62,.12);color:var(--gold);font-size:15px;font-weight:700;padding:4px 10px;border-radius:6px;margin-left:8px;letter-spacing:0">09:00 – 18:00</span></div>
<div class="card-title">Siparişleri İndir</div>
<div class="card-desc">Bekleyen siparişleri Yurtiçi Kargo'ya yüklenecek Excel dosyasına dönüştürür</div>
<div style="margin-top:10px;font-size:14px;color:var(--gold);font-weight:600">▶ Buraya tıklayın</div>
<div class="card-icon"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
</div>
<div class="card" onclick="showPanel('import')">
<div class="card-num">ADIM 2 <span style="display:inline-block;background:rgba(175,140,62,.12);color:var(--gold);font-size:15px;font-weight:700;padding:4px 10px;border-radius:6px;margin-left:8px;letter-spacing:0">18:00 sonrası</span></div>
<div class="card-title">Takip Kodlarını Gir</div>
<div class="card-desc">Yurtiçi'den indirdiğiniz listeyi yükleyin, takip kodları otomatik girilsin</div>
<div style="margin-top:10px;font-size:14px;color:var(--gold);font-weight:600">▶ Buraya tıklayın</div>
<div class="card-icon"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
</div>
<div class="card" onclick="showPanel('payment')">
<div class="card-num" style="color:var(--red)">ÖDEME TAKİP</div>
<div class="card-title">Ödeme Bekleyenler</div>
<div class="card-desc">Ödemesi gelmemiş siparişleri listele, hatırlatma e-postası gönder</div>
<div style="margin-top:10px;font-size:14px;color:var(--gold);font-weight:600">▶ Buraya tıklayın</div>
<div class="card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div>
</div>
</div>

<!-- PANEL 1: Export -->
<div class="panel" id="panel-export">
<h3><svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Bekleyen Siparişleri İndir</h3>
<p style="font-size:18px;color:var(--tx2);margin-bottom:16px">Ecwid'den ödendi/işleme alındı durumdaki siparişleri çeker ve Yurtiçi Kargo Excel şablonuna dönüştürür.</p>
<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px">
<button class="btn btn-gold" id="btn-fetch" onclick="fetchOrders()"><span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.3);font-size:14px;font-weight:800;margin-right:6px">1</span> Siparişleri Çek</button>
<a href="https://ykss.yurticikargo.com/cargo?cargo=file+shipment" target="_blank" class="btn btn-gold"><span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.3);font-size:14px;font-weight:800;margin-right:6px">2</span> Dosyayı Yurtiçi'ye Yükle</a>
<a href="https://ykss.yurticikargo.com/cargo?cargo=delivery+list&delivery+list=active+deliveries" target="_blank" class="btn btn-gold"><span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.3);font-size:14px;font-weight:800;margin-right:6px">3</span> Teslim Listesini Onayla</a>
</div>
<div class="progress" id="prog-export"><div class="progress-bar" id="pbar-export"></div></div>
<div id="export-preview"></div>
<div class="log" id="log-export" style="display:none"></div>
</div>

<!-- PANEL 2: Import -->
<div class="panel" id="panel-import">
<h3><svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Takip Kodlarını Yükle</h3>
<p style="font-size:18px;color:var(--tx2);margin-bottom:12px">Önce aşağıdaki linkten bugünkü giden kargoları Excel olarak indirin, sonra buraya sürükleyin.</p>
<div style="text-align:center;margin-bottom:14px">
<a href="https://ykss.yurticikargo.com/onlineReports/outgoingCargo" target="_blank" class="btn btn-gold" style="text-decoration:none" id="btn-yk-report"><span style="display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,.3);font-size:13px;font-weight:800;margin-right:4px">1</span> Yurtiçi'den Giden Kargoları İndir</a>
</div>
<p style="font-size:16px;color:var(--tx3);margin-bottom:12px" id="yk-date-hint"></p>
<script>!function(){var d=new Date(),dd=('0'+d.getDate()).slice(-2),mm=('0'+(d.getMonth()+1)).slice(-2),yy=d.getFullYear(),t=dd+'.'+mm+'.'+yy;document.getElementById('yk-date-hint').innerHTML='Başlangıç ve Bitiş tarihini <b style="color:var(--tx)">'+t+'</b> yapıp Sorgula\'ya basın, sonra <b style="color:var(--tx)">Excel\'e Aktar</b>\'a tıklayın.'}()</script>
<div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()" style="min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px">
<svg viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:48px;height:48px;opacity:.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
<p>İndirdiğiniz Excel dosyasını buraya sürükleyin veya tıklayın</p>
<input type="file" id="file-input" accept=".xlsx,.xls">
</div>
<div class="progress" id="prog-import"><div class="progress-bar" id="pbar-import"></div></div>
<div id="import-preview"></div>
<div class="log" id="log-import" style="display:none"></div>
</div>

<!-- PANEL 3: Payment Reminders -->
<div class="panel" id="panel-payment">
<h3><svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Ödeme Bekleyen Siparişler</h3>
<p style="font-size:18px;color:var(--tx2);margin-bottom:16px">Ödemesi henüz gelmemiş siparişleri listeler. Hatırlatma e-postası göndermeden önce içeriğini önizleyebilirsiniz.</p>

<!-- Auto Reminder Toggle -->
<div style="border:2px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;background:var(--bg)" id="auto-reminder-box">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:14px">
<div>
<p style="margin:0 0 4px;font-size:18px;font-weight:700;color:var(--tx)">Otomatik Hatırlatma</p>
<p style="margin:0;font-size:14px;color:var(--tx3)">Hafta içi 10:00 - 17:15 arası otomatik mail gönderir</p>
</div>
<div style="display:flex;align-items:center;gap:10px">
<span id="auto-status-text" style="font-size:14px;font-weight:600;color:var(--tx3)">Yükleniyor...</span>
<label style="position:relative;display:inline-block;width:60px;height:32px;cursor:pointer">
<input type="checkbox" id="auto-toggle" onchange="toggleAutoReminder(this.checked)" style="opacity:0;width:0;height:0">
<span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;border-radius:32px;transition:.3s" id="auto-slider"></span>
</label>
</div>
</div>

<!-- Dakika Ayarı -->
<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px">
<label style="font-size:16px;font-weight:600;color:var(--tx)">Bekleme süresi:</label>
<div style="display:flex;align-items:center;gap:6px">
<button class="btn btn-outline" onclick="adjustThreshold(-5)" style="padding:6px 12px;font-size:18px;font-weight:700">−</button>
<span id="threshold-val" style="font-size:24px;font-weight:800;color:var(--gold);min-width:50px;text-align:center">45</span>
<button class="btn btn-outline" onclick="adjustThreshold(5)" style="padding:6px 12px;font-size:18px;font-weight:700">+</button>
<span style="font-size:16px;color:var(--tx2)">dakika</span>
</div>
<button class="btn btn-outline" onclick="saveThreshold()" style="font-size:14px;padding:6px 16px" id="btn-save-threshold">Kaydet</button>
</div>

<!-- Test Modu -->
<button class="btn btn-outline" onclick="testAutoReminder()" id="btn-test-auto" style="font-size:16px;padding:10px 22px;width:100%">Test Et (mail göndermeden kontrol et)</button>
<div id="test-result" style="display:none;margin-top:12px;border:1px solid var(--border);border-radius:8px;padding:14px;background:var(--bg2)"></div>
</div>

<button id="btn-unpaid" class="btn btn-gold" onclick="fetchUnpaid()" style="font-size:18px;padding:14px 28px;margin-bottom:12px">Ödeme Bekleyenleri Çek</button>
<div class="progress" id="prog-payment"><div class="progress-bar" id="pbar-payment"></div></div>
<div id="payment-preview"></div>
<div class="log" id="log-payment" style="display:none"></div>
</div>

</div><!-- /container -->

<!-- PIN CHANGE MODAL -->
<div id="pin-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);z-index:999;display:none;justify-content:center;align-items:center" onclick="if(event.target===this)togglePinModal()">
<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:340px;width:90%;box-shadow:0 16px 48px rgba(0,0,0,.15)" onclick="event.stopPropagation()">
<p style="font-size:22px;font-weight:700;color:var(--tx);margin-bottom:16px">PIN Değiştir</p>
<label style="font-size:16px;color:var(--tx2);display:block;margin-bottom:6px">Mevcut PIN</label>
<input type="password" id="old-pin" maxlength="4" inputmode="numeric" placeholder="● ● ● ●" style="width:100%;padding:12px;font-size:22px;text-align:center;letter-spacing:12px;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;margin-bottom:12px">
<label style="font-size:16px;color:var(--tx2);display:block;margin-bottom:6px">Yeni PIN (4 haneli)</label>
<input type="password" id="new-pin" maxlength="4" inputmode="numeric" placeholder="● ● ● ●" style="width:100%;padding:12px;font-size:22px;text-align:center;letter-spacing:12px;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--tx);font-family:inherit;outline:none;margin-bottom:16px">
<button class="btn btn-gold" onclick="changePin()" style="width:100%;justify-content:center;font-size:14px">Kaydet</button>
</div>
</div>

</div><!-- /main-screen -->

<!-- TESLIM LISTESI POPUP -->
<div id="teslim-overlay" class="teslim-overlay" style="display:none">
<div class="teslim-box">
<div style="margin-bottom:14px"><span class="live-badge">CANLI</span></div>
<div style="font-size:40px;margin-bottom:10px">⚠️</div>
<div style="font-size:22px;font-weight:800;color:var(--red);margin-bottom:8px">TESLİM LİSTESİ ONAYLANDI MI?</div>
<div style="font-size:17px;color:var(--tx2);margin-bottom:6px;line-height:1.6">Onaylanmazsa bugünkü kargolar <b style="color:var(--red)">çıkmaz!</b></div>
<div style="font-size:15px;color:var(--tx3);margin-bottom:20px">Yurtiçi Kargo panelinden teslim listesini onaylayın.</div>
<a href="https://ykss.yurticikargo.com/cargo?cargo=delivery+list&delivery+list=active+deliveries" target="_blank" class="btn btn-gold" style="width:100%;justify-content:center;font-size:18px;padding:16px;margin-bottom:10px" onclick="teslimDismiss()">Teslim Listesini Onayla</a>
<button class="btn btn-outline" onclick="teslimDismiss()" style="width:100%;justify-content:center;font-size:16px;font-weight:700;padding:14px;color:var(--tx);border:2px solid var(--border)">Onayladım, kapat</button>
</div>
</div>

<!-- TESLIM MINI BADGE (persistent after dismiss) -->
<a id="teslim-mini" class="teslim-mini" href="https://ykss.yurticikargo.com/cargo?cargo=delivery+list&delivery+list=active+deliveries" target="_blank" style="display:none">
<span class="live-badge">CANLI</span>
Teslim Listesi
</a>

<div class="footer">Manhattan Likit · Kargo Yönetim Paneli</div>

<!-- MAIL GÖNDER POPUP -->
<div id="send-popup" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);z-index:9998;justify-content:center;align-items:center" onclick="if(event.target===this)closeSendPopup()">
<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:440px;width:90%;box-shadow:0 16px 48px rgba(0,0,0,.15)" onclick="event.stopPropagation()">
<p style="font-size:22px;font-weight:700;color:var(--tx);margin-bottom:6px" id="popup-title">Hatırlatma Gönder</p>
<p style="font-size:15px;color:var(--tx2);margin-bottom:20px;line-height:1.5" id="popup-desc">Seçili siparişlere hatırlatma e-postası gönderilecek.</p>
<div id="popup-list" style="max-height:200px;overflow-y:auto;margin-bottom:16px;border:1px solid var(--border);border-radius:8px;padding:8px"></div>
<div style="display:flex;gap:10px">
<button class="btn btn-gold" id="popup-confirm" onclick="confirmSendPopup()" style="flex:1;justify-content:center;font-size:16px;padding:14px">Gönder</button>
<button class="btn btn-outline" onclick="closeSendPopup()" style="flex:1;justify-content:center;font-size:16px;padding:14px">İptal</button>
</div>
</div>
</div>

<script>
// === CONFIG ===
const GAS_URL='https://script.google.com/macros/s/AKfycbxJKzibWzYOmapPvghMPxbt9u5vjGQyxCXZae4FKfUEsjCMIWEqkyI2CM_CovOGrzTbXQ/exec';
const YK_TRACK_URL='https://ykss.yurticikargo.com/reports/SSWDocumentDetail/';
const CARGO_DEFAULTS={
  kargoTuru:0,    // DOSYA
  odemeTipi:1,    // GÖNDERİCİ
  adet:1,
  icerik:'BODY BUTTER'
};
var SESSION_PIN=null;
// 24h session check
!function(){var s=localStorage.getItem("kargo_session");if(s){try{var d=JSON.parse(s);if(d.pin&&d.exp>Date.now()){SESSION_PIN=d.pin;document.addEventListener("DOMContentLoaded",function(){document.getElementById("pin-screen").style.display="none";document.getElementById("main-screen").style.display="block";document.getElementById("header-right").style.display="flex";document.getElementById("pin-user").textContent="Kullanıcı "+d.user;autoOpenExport()})}}catch(e){}}}();
var FAIL_COUNT=0;
var LOCKED_UNTIL=0;

// === HELPERS ===
function ts(){var d=new Date();return d.getFullYear()+('0'+(d.getMonth()+1)).slice(-2)+('0'+d.getDate()).slice(-2)+'_'+('0'+d.getHours()).slice(-2)+('0'+d.getMinutes()).slice(-2)}
function normPhone(p){if(!p)return'';return String(p).replace(/\D/g,'').slice(-10)}
function log(id,msg,type){
  var el=document.getElementById(id);el.style.display='block';
  var colors={ok:'var(--green)',skip:'var(--tx3)',err:'var(--red)',info:'var(--blue)'};
  el.innerHTML+='<div class="log-item"><div class="log-dot" style="background:'+colors[type||'info']+'"></div><span class="log-'+(type||'info')+'">'+msg+'</span></div>';
  el.scrollTop=el.scrollHeight;
}
function setProgress(barId,pct){document.getElementById(barId).style.width=pct+'%'}

async function gasPost(body){
  var r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify(body)});
  var text=await r.text();
  try{return JSON.parse(text)}catch(e){return{ok:false,error:'Sunucu yanıt hatası'}}
}

// === PIN SYSTEM ===
async function verifyPin(){
  var inp=document.getElementById('pin-input');
  var pin=inp.value.trim();
  if(!pin){inp.focus();return}
  
  var now=Date.now();
  if(LOCKED_UNTIL>now){
    showPinMsg('⏳ '+Math.ceil((LOCKED_UNTIL-now)/60000)+' dakika bekleyin.',true);
    return;
  }
  
  document.getElementById('pin-btn').disabled=true;
  document.getElementById('pin-btn').textContent='Kontrol ediliyor...';
  
  var res=await gasPost({action:'kargoVerifyPin',pin:pin});
  
  if(res.ok){
    SESSION_PIN=pin;
    localStorage.setItem('kargo_session',JSON.stringify({pin:pin,user:res.user,exp:Date.now()+86400000}));
    localStorage.setItem('kargo_session',JSON.stringify({pin:pin,user:res.user,exp:Date.now()+24*60*60*1000}));
    FAIL_COUNT=0;
    document.getElementById('pin-screen').style.display='none';
    document.getElementById('main-screen').style.display='block';
    document.getElementById('header-right').style.display='flex';
    document.getElementById('pin-user').textContent='Kullanıcı '+res.user;
    autoOpenExport();
  }else{
    if(res.locked){
      LOCKED_UNTIL=now+5*60*1000;
      showPinMsg('⏳ Çok fazla hatalı deneme. 5 dakika bekleyin.',true);
    }else{
      FAIL_COUNT++;
      var rem=res.remaining!=null?res.remaining:(5-FAIL_COUNT);
      showPinMsg('Hatalı PIN. Kalan hak: '+rem,rem<=2);
    }
    inp.value='';inp.focus();
  }
  document.getElementById('pin-btn').disabled=false;
  document.getElementById('pin-btn').textContent='Giriş';
}

function showPinMsg(msg,isErr){
  var el=document.getElementById('pin-msg');
  el.textContent=msg;
  el.style.color=isErr?'var(--red)':'var(--tx2)';
  el.style.display='block';
}

async function changePin(){
  var oldP=document.getElementById('old-pin').value.trim();
  var newP=document.getElementById('new-pin').value.trim();
  if(!oldP||!newP){alert('Eski ve yeni PIN girin.');return}
  if(!/^\d{4}$/.test(newP)){alert('Yeni PIN 4 haneli sayı olmalı.');return}
  
  var res=await gasPost({action:'kargoChangePin',pin:oldP,newPin:newP});
  if(res.ok){
    SESSION_PIN=newP;
    var prev=JSON.parse(localStorage.getItem('kargo_session')||'{}');
    localStorage.setItem('kargo_session',JSON.stringify({pin:newP,user:prev.user||'',exp:Date.now()+86400000}));
    alert('PIN başarıyla değiştirildi.');
    document.getElementById('pin-modal').style.display='none';
    document.getElementById('old-pin').value='';
    document.getElementById('new-pin').value='';
  }else{
    alert(res.error||'Hata oluştu.');
  }
}

function togglePinModal(){
  var m=document.getElementById('pin-modal');
  m.style.display=m.style.display==='block'?'none':'block';
}

// === PANEL TOGGLE ===
function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show'));
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('show');
  var cards=document.querySelectorAll('.card');
  var idx={export:0,import:1,payment:2};
  if(idx[id]!==undefined&&cards[idx[id]])cards[idx[id]].classList.add('active');
}

function autoOpenExport(){
  setTimeout(function(){showPanel('export')},100);
  setTimeout(checkAutoStatus,500);
}

// === BUTON 1: Siparişleri Çek → Yurtiçi Excel ===
async function fetchOrders(){
  var btn=document.getElementById('btn-fetch');
  btn.disabled=true;btn.textContent='Çekiliyor...';
  document.getElementById('log-export').innerHTML='';
  document.getElementById('export-preview').innerHTML='';
  setProgress('pbar-export',10);

  try{
    log('log-export','Ecwid siparişleri çekiliyor...','info');
    
    var res=await gasPost({action:'kargoGetOrders',pin:SESSION_PIN});
    setProgress('pbar-export',50);
    
    if(!res.ok){
      log('log-export','HATA: '+(res.error||'Bilinmeyen hata'),'err');
      btn.disabled=false;btn.textContent='Siparişleri Çek';
      return;
    }
    
    var allOrders=res.orders||[];
    
    if(allOrders.length===0){
      log('log-export','Bekleyen sipariş bulunamadı.','skip');
      btn.disabled=false;btn.textContent='Siparişleri Çek';
      setProgress('pbar-export',100);
      return;
    }

    log('log-export','Toplam '+allOrders.length+' bekleyen sipariş bulundu.','ok');

    // Build Yurtiçi template data
    var headers=['Kişi / Kurum Adı (*)','Adresi (*)','İl','İlçe','Telefon Ev/İş','Telefon Cep','E-Mail Adresi','Vergi No','Kargo Türü (*)','Ödeme Tipi (*)','İrsaliye Numarası','Referans Numarası','Adet (*)','Kargo İçeriği','Tahsilat Tipi','Fatura Numarası','Fatura Tutarı','Dosya/Poşet No','Kampanya No','Kampanya Kodu'];
    var rows=[headers];
    var preview=[];

    allOrders.forEach(function(o){
      var rawMethod=o.shippingMethod||'';
      var cleanMethod=rawMethod.replace(/\s*\(.*?\)\s*/g,'').trim()||'Belirtilmemiş';
      var isYurtici=/yurtici|yurtiçi|yurti/i.test(rawMethod);
      
      if(isYurtici){
        var fullAddr=o.street;
        if(o.city&&!o.street.toUpperCase().includes(o.city.toUpperCase())){
          fullAddr+=' '+o.city;
        }

        var row=[
          o.name,                    // A: Kişi/Kurum
          fullAddr.toUpperCase(),    // B: Adres
          (o.state||'').toUpperCase(),// C: İl
          (o.city||'').toUpperCase(),// D: İlçe
          '',                        // E: Telefon Ev/İş
          normPhone(o.phone),        // F: Telefon Cep
          '',                        // G: E-Mail
          '',                        // H: Vergi No
          CARGO_DEFAULTS.kargoTuru,  // I: 0=DOSYA
          CARGO_DEFAULTS.odemeTipi,  // J: 1=GÖNDERİCİ
          '',                        // K: İrsaliye No
          '',                        // L: Referans No (boş)
          CARGO_DEFAULTS.adet,       // M: 1
          CARGO_DEFAULTS.icerik,     // N: BODY BUTTER
          '',                        // O: Tahsilat Tipi
          '',                        // P: Fatura No
          '',                        // Q: Fatura Tutarı
          '',                        // R: Dosya/Poşet No
          '',                        // S: Kampanya No
          ''                         // T: Kampanya Kodu
        ];
        rows.push(row);
      }
      preview.push({name:o.name,state:o.state,city:o.city,phone:normPhone(o.phone),orderId:o.id,orderNum:o.orderNumber,shippingMethod:cleanMethod,isYurtici:isYurtici});
      if(isYurtici){
        log('log-export','#'+o.orderNumber+' · '+o.name+' · '+(o.state||'')+' / '+(o.city||''),'ok');
      }else{
        log('log-export','<span style="color:#c0392b;font-weight:600">#'+o.orderNumber+' · '+o.name+' · '+(o.state||'')+' / '+(o.city||'')+' · '+cleanMethod+' — Excel\'e işlenmedi, ayrı olarak giriniz</span>','err');
      }
    });

    setProgress('pbar-export',80);

    // Generate Excel (only if Yurtiçi orders exist)
    var wb=XLSX.utils.book_new();
    var ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[{wch:30},{wch:50},{wch:15},{wch:15},{wch:15},{wch:15},{wch:25},{wch:12},{wch:10},{wch:10},{wch:15},{wch:15},{wch:8},{wch:15},{wch:10},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12}];
    XLSX.utils.book_append_sheet(wb,ws,'Sheet1');
    var fname='YK_Kargo_'+ts()+'.xlsx';
    
    var yurticiCount=rows.length-1;
    if(yurticiCount>0){
      XLSX.writeFile(wb,fname);
      log('log-export','✓ '+fname+' indirildi — '+yurticiCount+' Yurtiçi sipariş','ok');
    }else{
      log('log-export','Yurtiçi Kargo siparişi bulunamadı. Excel oluşturulmadı.','skip');
    }
    setProgress('pbar-export',100);

    // Preview table
    var otherCount=preview.length-yurticiCount;
    var html='<div class="stats"><div class="stat"><div class="stat-val">'+allOrders.length+'</div><div class="stat-label">Toplam Sipariş</div></div><div class="stat"><div class="stat-val" style="color:var(--green)">'+yurticiCount+'</div><div class="stat-label">Yurtiçi Kargo</div></div>'+(otherCount?'<div class="stat"><div class="stat-val" style="color:var(--red)">'+otherCount+'</div><div class="stat-label">Sürat Kargo<br><span style="font-size:10px;font-weight:400;color:var(--tx3)">Excel\'e işlenmedi</span></div></div>':'')+'</div>';
    preview.sort(function(a,b){return a.isYurtici===b.isYurtici?0:a.isYurtici?1:-1;});
    html+='<div class="table-wrap"><table><tr><th>Sipariş</th><th>Müşteri</th><th>İl</th><th>İlçe</th><th>Telefon</th><th>Kargo</th></tr>';
    preview.forEach(function(p){
      var rowStyle=p.isYurtici?'':'style="background:rgba(231,76,60,.08);color:#c0392b"';
      var kargoLabel=p.isYurtici?'<span style="color:#27ae60;font-weight:600">Yurtiçi Kargo</span>':'<span style="color:#c0392b;font-weight:600">'+p.shippingMethod+'</span>';
      html+='<tr '+rowStyle+'><td>#'+p.orderNum+'</td><td>'+p.name+'</td><td>'+(p.state||'')+'</td><td>'+(p.city||'')+'</td><td>'+p.phone+'</td><td>'+kargoLabel+'</td></tr>';
    });
    html+='</table></div>';
    document.getElementById('export-preview').innerHTML=html;

  }catch(e){
    log('log-export','HATA: '+e.message,'err');
  }
  btn.disabled=false;btn.textContent='Siparişleri Çek';
}

// === BUTON 2: Results Upload → Ecwid Tracking ===
var dropZone=document.getElementById('drop-zone');
var fileInput=document.getElementById('file-input');

dropZone.addEventListener('dragover',function(e){e.preventDefault();dropZone.classList.add('dragover')});
dropZone.addEventListener('dragleave',function(){dropZone.classList.remove('dragover')});
dropZone.addEventListener('drop',function(e){e.preventDefault();dropZone.classList.remove('dragover');if(e.dataTransfer.files.length)processResults(e.dataTransfer.files[0])});
fileInput.addEventListener('change',function(){if(fileInput.files.length)processResults(fileInput.files[0])});

async function processResults(file){
  document.getElementById('log-import').innerHTML='';
  document.getElementById('import-preview').innerHTML='';
  setProgress('pbar-import',5);
  log('log-import','Dosya okunuyor: '+file.name,'info');

  try{
    var data=await file.arrayBuffer();
    var wb=XLSX.read(data);
    var ws=wb.Sheets[wb.SheetNames[0]];
    var json=XLSX.utils.sheet_to_json(ws,{defval:''});
    
    if(!json.length){log('log-import','Dosyada veri bulunamadı.','err');return}
    
    log('log-import',json.length+' satır okundu.','info');
    setProgress('pbar-import',15);

    // Find column mappings dynamically
    var cols=Object.keys(json[0]);
    var colTrack=cols.find(c=>/gönderi.*kodu|takip.*no/i.test(c))||cols[1];
    var colName=cols.find(c=>/alıcı.*müşteri$/i.test(c))||cols[3];
    var colPhone=cols.find(c=>/alıcı.*telefon/i.test(c))||cols[6];
    var colOzel1=cols.find(c=>c==='Özel Alan 1');
    var colOzel=cols.find(c=>c==='Özel Alan'&&c!=='Özel Alan 1'&&c!=='Özel Alan 2');
    var colRef=cols.find(c=>/referans/i.test(c));
    
    log('log-import','Kolon eşlemesi: Takip='+colTrack+', Ad='+colName,'info');

    // Parse results rows
    var shipments=json.map(function(r){
      var trackCode=String(r[colTrack]||'').trim();
      var name=String(r[colName]||'').trim();
      var phone=normPhone(r[colPhone]);
      var ozel1=String(r[colOzel1]||'').trim();
      var ozel=String(r[colOzel]||r[colRef]||'').trim();
      var ecwidId=ozel1||'';
      if(!ecwidId&&ozel){
        var m=ozel.match(/Müşteri Kargo Ref Kodu[:\s]*(\d+)/i)||ozel.match(/Sipariş No[:\s]*(\d+)/i);
        if(m)ecwidId=m[1];
      }
      return{trackCode:trackCode,name:name,phone:phone,ecwidId:ecwidId};
    }).filter(function(s){return s.trackCode});
    
    log('log-import',shipments.length+' geçerli gönderi bulundu.','info');
    setProgress('pbar-import',25);

    var updated=0,skipped=0,notFound=0,errors=0;
    
    for(var i=0;i<shipments.length;i++){
      var s=shipments[i];
      setProgress('pbar-import',25+Math.round(i/shipments.length*70));
      
      var orderId=null;
      var orderNum=null;
      var alreadyShipped=false;
      
      // Strategy 1: Direct match via Özel Alan
      if(s.ecwidId&&/^\d+$/.test(s.ecwidId)){
        var chk=await gasPost({action:'kargoCheckOrder',pin:SESSION_PIN,orderId:s.ecwidId});
        if(chk.ok){
          orderId=chk.id;
          orderNum=chk.orderNumber;
          if(chk.fulfillmentStatus==='SHIPPED')alreadyShipped=true;
        }
      }
      
      // Strategy 2: Phone fallback
      if(!orderId&&s.phone){
        var ph=await gasPost({action:'kargoSearchByPhone',pin:SESSION_PIN,phone:s.phone});
        if(ph.ok){
          orderId=ph.id;
          orderNum=ph.orderNumber;
          if(ph.fulfillmentStatus==='SHIPPED')alreadyShipped=true;
        }
      }
      
      // Already shipped — önceden girilmiş
      if(alreadyShipped){
        log('log-import','⏭ Kargo takibi önceden girilmiş: #'+(orderNum||orderId)+' · '+s.name,'skip');
        skipped++;
        continue;
      }
      
      // Not found at all
      if(!orderId){
        log('log-import','✗ Eşleşmedi: '+s.name+' — Farklı kargo firması (Sürat, MNG vb.) olabilir','err');
        notFound++;
        continue;
      }
      
      // Update tracking
      var upd=await gasPost({action:'kargoUpdateTracking',pin:SESSION_PIN,orderId:String(orderId),trackCode:s.trackCode});
      if(upd.ok){
        log('log-import','✓ #'+(orderNum||orderId)+' · '+s.name+' → '+s.trackCode,'ok');
        updated++;
      }else{
        log('log-import','✗ Güncelleme hatası #'+orderId+': '+(upd.error||''),'err');
        errors++;
      }
      
      await new Promise(function(r){setTimeout(r,200)});
    }
    
    setProgress('pbar-import',100);
    
    var html='<div class="stats">';
    html+='<div class="stat"><div class="stat-val" style="color:var(--green)">'+updated+'</div><div class="stat-label">Güncellendi</div></div>';
    html+='<div class="stat"><div class="stat-val" style="color:var(--tx3)">'+skipped+'</div><div class="stat-label">Atlandı (önceden girilmiş)</div></div>';
    if(notFound)html+='<div class="stat"><div class="stat-val" style="color:var(--red)">'+notFound+'</div><div class="stat-label">Eşleşmedi</div></div>';
    if(errors)html+='<div class="stat"><div class="stat-val" style="color:var(--red)">'+errors+'</div><div class="stat-label">Hata</div></div>';
    html+='</div>';
    
    log('log-import','─── Tamamlandı: '+updated+' güncellendi, '+skipped+' atlandı'+(notFound?', '+notFound+' eşleşmedi':'')+(errors?', '+errors+' hata':''),'info');
    document.getElementById('import-preview').innerHTML=html;
    
  }catch(e){
    log('log-import','HATA: '+e.message,'err');
  }
}
// === BUTON 3: Ödeme Bekleyenleri Çek ===
var UNPAID_ORDERS=[];
var SEND_QUEUE=[];
var SEND_CALLBACK=null;

async function fetchUnpaid(){
  var btn=document.getElementById('btn-unpaid');
  btn.disabled=true;btn.textContent='Çekiliyor...';
  document.getElementById('log-payment').innerHTML='';
  document.getElementById('payment-preview').innerHTML='';
  
  log('log-payment','Ödeme bekleyen siparişler çekiliyor...','info');
  setProgress('pbar-payment',20);
  
  var res=await gasPost({action:'kargoGetUnpaid',pin:SESSION_PIN});
  setProgress('pbar-payment',80);
  
  if(!res.ok){
    log('log-payment','HATA: '+(res.error||'Bilinmeyen hata'),'err');
    btn.disabled=false;btn.textContent='Ödeme Bekleyenleri Çek';
    return;
  }
  
  UNPAID_ORDERS=res.orders||[];
  if(UNPAID_ORDERS.length===0){
    log('log-payment','Ödeme bekleyen sipariş bulunamadı.','skip');
    btn.disabled=false;btn.textContent='Ödeme Bekleyenleri Çek';
    setProgress('pbar-payment',100);
    return;
  }
  
  log('log-payment','Toplam '+UNPAID_ORDERS.length+' ödeme bekleyen sipariş bulundu.','ok');
  
  // Stats
  var notSent=UNPAID_ORDERS.filter(function(o){return !o.alreadySent}).length;
  var sent=UNPAID_ORDERS.length-notSent;
  var html='<div class="stats">';
  html+='<div class="stat"><div class="stat-val">'+UNPAID_ORDERS.length+'</div><div class="stat-label">Ödeme Bekleyen</div></div>';
  if(notSent)html+='<div class="stat"><div class="stat-val" style="color:var(--red)">'+notSent+'</div><div class="stat-label">Mail gönderilmemiş</div></div>';
  if(sent)html+='<div class="stat"><div class="stat-val" style="color:var(--green)">'+sent+'</div><div class="stat-label">Mail gönderilmiş</div></div>';
  html+='</div>';
  
  // Main action buttons
  html+='<div style="display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap;align-items:center">';
  if(notSent){
    html+='<button class="btn btn-gold" onclick="bulkSendUnsent()" style="font-size:20px;padding:16px 32px;flex:1">Gönderilmeyenlere Hatırlatma Gönder ('+notSent+')</button>';
  }
  html+='<button class="btn btn-outline" onclick="bulkSendAll()" style="font-size:16px;padding:16px 24px">Hepsine Gönder ('+UNPAID_ORDERS.length+')</button>';
  html+='</div>';
  
  // Checkbox bar
  html+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap">';
  html+='<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:16px;color:var(--tx2)"><input type="checkbox" id="chk-all" onchange="toggleAllUnpaid(this.checked)" style="width:20px;height:20px"> Tümünü Seç</label>';
  html+='<button class="btn btn-gold" onclick="bulkSendSelected()" style="font-size:16px;padding:10px 22px">Seçilenlere Gönder</button>';
  html+='</div>';
  
  // Order list - simple rows
  UNPAID_ORDERS.forEach(function(o,idx){
    var timeColor=o.elapsedMin>=45?'var(--red)':o.elapsedMin>=20?'#f59e0b':'var(--green)';
    var timeLabel=o.elapsedMin>=60?Math.floor(o.elapsedMin/60)+' saat '+(o.elapsedMin%60)+' dk':o.elapsedMin+' dk';
    var sentBadge=o.alreadySent?'<span style="display:inline-block;background:rgba(39,174,96,.1);color:#27ae60;font-size:14px;font-weight:600;padding:4px 12px;border-radius:6px;margin-left:8px">Gönderildi</span>':'';
    var noBankBadge=!o.bankInfo?'<span style="display:inline-block;background:#fef2f2;color:#b91c1c;font-size:12px;font-weight:600;padding:3px 8px;border-radius:4px;margin-left:8px">Banka bilgisi yok</span>':'';
    
    html+='<div style="border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;background:var(--bg2)" id="card-'+o.id+'">';
    
    // Single row: checkbox + order# + bold name + email + time
    html+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
    html+='<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">';
    html+='<input type="checkbox" class="chk-unpaid" value="'+idx+'" style="width:20px;height:20px;cursor:pointer">';
    html+='<span style="font-size:18px;color:var(--gold);font-weight:700">#'+o.orderNumber+'</span>';
    html+='<span style="font-size:18px;font-weight:800;color:var(--tx)">'+o.name+'</span>';
    html+='<span style="font-size:14px;color:var(--tx3)">'+o.email+'</span>';
    html+=sentBadge+noBankBadge;
    html+='</div>';
    html+='<div style="display:flex;align-items:center;gap:8px">';
    html+='<span style="font-size:16px;font-weight:700;color:'+timeColor+'">'+timeLabel+'</span>';
    html+='<button class="btn btn-gold" onclick="singleSend('+idx+')" style="font-size:13px;padding:6px 14px" id="sbtn-'+o.id+'">'+(o.alreadySent?'Tekrar Gönder':'Mail Gönder')+'</button>';
    html+='<button class="btn btn-outline" onclick="toggleMailPreview(\'mail-preview-'+idx+'\')" style="font-size:13px;padding:6px 14px">Mail Önizle</button>';
    html+='</div></div>';
    
    // Mail preview (hidden) - matching original template
    var bankPreview=o.bankInfo?o.bankInfo.replace(/\n/g,'<br>'):'Banka bilgisi bulunamadı.';
    var totalPreview=(o.total||0).toLocaleString('tr-TR',{minimumFractionDigits:2})+' TL';
    html+='<div id="mail-preview-'+idx+'" style="display:none;margin-top:12px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#fff">';
    html+='<div style="padding:16px 20px;border-bottom:1px solid #eee"><p style="margin:0;font-size:20px;font-weight:normal;color:#333">Sipariş Durumu</p></div>';
    html+='<div style="padding:16px 20px">';
    html+='<p style="margin:0 0 16px;font-size:15px;color:#333">Merhaba <strong>'+o.name+'</strong>, <strong>#'+o.orderNumber+'</strong> numaralı siparişiniz için ödeme beklenmektedir.</p>';
    
    // Havale başlık
    html+='<div style="background:#166534;padding:10px 14px;margin-bottom:10px"><p style="margin:0;font-size:16px;font-weight:bold;color:#fff">Havale / EFT / FAST Talimatları</p></div>';
    
    // Dikkat kutusu
    html+='<div style="display:flex;margin-bottom:10px"><div style="width:4px;background:#22c55e;flex-shrink:0"></div><div style="background:#f0fdf4;padding:12px 14px;flex:1">';
    html+='<p style="margin:0 0 8px;font-size:14px;font-weight:bold;color:#166534">Ödeme Yaparken Dikkat Edin</p>';
    html+='<p style="margin:0 0 4px;font-size:13px;color:#333">✓ Açıklama kısmını <strong>boş bırakın</strong></p>';
    html+='<p style="margin:0 0 4px;font-size:13px;color:#333">✓ Boş bırakamıyorsanız sadece <strong>adınızı ve soyadınızı</strong> yazın</p>';
    html+='<p style="margin:0;font-size:13px;color:#333">✗ Ürün adı, sipariş no veya benzeri ifadeler <strong>kesinlikle yazmayın</strong></p>';
    html+='</div></div>';
    
    // Neden önemli
    html+='<div style="display:flex;margin-bottom:10px"><div style="width:4px;background:#f59e0b;flex-shrink:0"></div><div style="background:#fffbeb;padding:12px 14px;flex:1">';
    html+='<p style="margin:0 0 4px;font-size:14px;font-weight:bold;color:#b45309">Neden Bu Kadar Önemli?</p>';
    html+='<p style="margin:0;font-size:13px;color:#555">Bankalar açıklama kısmındaki belirli kelimeleri otomatik olarak tarar. Bu tür ifadeler <strong>sizin hesaplarınızda</strong> da sorunlara yol açabilir.</p>';
    html+='</div></div>';
    
    // Kurallara uyulmaması
    html+='<div style="display:flex;margin-bottom:10px"><div style="width:4px;background:#dc2626;flex-shrink:0"></div><div style="background:#fef2f2;padding:12px 14px;flex:1">';
    html+='<p style="margin:0 0 4px;font-size:14px;font-weight:bold;color:#b91c1c">Kurallara Uyulmaması Halinde</p>';
    html+='<p style="margin:0;font-size:13px;color:#555">Siparişiniz iptal edilir · Ödemeniz masraflar düşülerek iade edilir · Sonraki siparişleriniz kabul edilmez</p>';
    html+='</div></div>';
    
    // Banka bilgisi + Tutar
    html+='<div style="border:2px solid #166534;margin-bottom:10px"><div style="background:#166534;padding:8px 14px"><p style="margin:0;font-size:13px;font-weight:bold;color:#fff">Geçici hesap bilgileridir. Kaydetmeyiniz.</p></div>';
    html+='<div style="background:#f0fdf4;padding:12px 14px"><p style="margin:0 0 6px;font-size:14px;font-weight:bold;color:#166534">Havale/EFT/FAST Bilgilerimiz</p><p style="margin:0;font-size:14px;line-height:24px;color:#333"><strong>'+bankPreview+'</strong></p></div>';
    html+='<div style="background:#dcfce7;padding:12px 14px;border-top:1px solid #bbf7d0"><p style="margin:0 0 4px;font-size:14px;font-weight:bold;color:#166534">Gönderilecek Tutar: '+totalPreview+'</p><p style="margin:0;font-size:12px;color:#166534">Açıklama kısmını boş bırakın. Talimatları okumadan gönderim yapmayınız.</p></div></div>';
    
    // Durum barı
    html+='<div style="background:#f8f8f8;padding:16px;text-align:center;margin-bottom:10px"><p style="margin:0 0 4px;font-size:16px;color:#333">Sipariş durumu: <b>İşlem Sırasında</b></p><p style="margin:0;font-size:18px;color:#333">Ödeme durumu: <b>Ödeme Bekleniyor</b></p></div>';
    
    // Footer
    html+='<p style="margin:0;font-size:11px;color:#999;text-align:center">Bu e-posta otomatik olarak gönderilmiştir. Ödemenizi zaten yaptıysanız lütfen dikkate almayınız.</p>';
    html+='</div></div>';
    
    html+='</div>';
  });
  
  document.getElementById('payment-preview').innerHTML=html;
  setProgress('pbar-payment',100);
  btn.disabled=false;btn.textContent='Ödeme Bekleyenleri Çek';
}

function toggleMailPreview(id){
  var el=document.getElementById(id);
  el.style.display=el.style.display==='none'?'block':'none';
}

function toggleAllUnpaid(checked){
  document.querySelectorAll('.chk-unpaid').forEach(function(c){c.checked=checked});
}

// Single send via popup
function singleSend(idx){
  var o=UNPAID_ORDERS[idx];
  openSendPopup([o],function(results){
    if(results[0]&&results[0].ok){
      var btn=document.getElementById('sbtn-'+o.id);
      btn.textContent='Gönderildi';btn.style.background='var(--green)';btn.style.borderColor='var(--green)';btn.style.color='#fff';btn.disabled=true;
      var card=document.getElementById('card-'+o.id);
      if(card)card.style.borderColor='var(--green)';
    }
  });
}

// Bulk send - selected checkboxes
function bulkSendSelected(){
  var checks=document.querySelectorAll('.chk-unpaid:checked');
  if(!checks.length){log('log-payment','Lütfen en az bir sipariş seçin.','err');return}
  var selected=[];
  checks.forEach(function(c){selected.push(UNPAID_ORDERS[parseInt(c.value)])});
  openSendPopup(selected,function(results){
    results.forEach(function(r,i){
      if(r&&r.ok){
        var btn=document.getElementById('sbtn-'+selected[i].id);
        if(btn){btn.textContent='Gönderildi';btn.style.background='var(--green)';btn.style.borderColor='var(--green)';btn.style.color='#fff';btn.disabled=true}
        var card=document.getElementById('card-'+selected[i].id);
        if(card)card.style.borderColor='var(--green)';
      }
    });
  });
}

// Bulk send - only unsent
function bulkSendUnsent(){
  var unsent=UNPAID_ORDERS.filter(function(o){return !o.alreadySent});
  if(!unsent.length){log('log-payment','Gönderilecek sipariş yok.','skip');return}
  openSendPopup(unsent,function(results){
    results.forEach(function(r,i){
      if(r&&r.ok){
        var card=document.getElementById('card-'+unsent[i].id);
        if(card)card.style.borderColor='var(--green)';
      }
    });
  });
}

// Bulk send - all (including already sent)
function bulkSendAll(){
  if(!UNPAID_ORDERS.length){log('log-payment','Gönderilecek sipariş yok.','skip');return}
  openSendPopup(UNPAID_ORDERS,function(results){
    results.forEach(function(r,i){
      if(r&&r.ok){
        var card=document.getElementById('card-'+UNPAID_ORDERS[i].id);
        if(card)card.style.borderColor='var(--green)';
      }
    });
  });
}

// Popup system
function openSendPopup(orders,callback){
  SEND_QUEUE=orders;
  SEND_CALLBACK=callback;
  var popup=document.getElementById('send-popup');
  var title=document.getElementById('popup-title');
  var desc=document.getElementById('popup-desc');
  var list=document.getElementById('popup-list');
  
  title.textContent=orders.length===1?'Hatırlatma Gönder':orders.length+' Siparişe Hatırlatma Gönder';
  desc.textContent=orders.length===1?orders[0].name+' adlı müşteriye hatırlatma e-postası gönderilecek.':orders.length+' müşteriye hatırlatma e-postası gönderilecek.';
  
  var lhtml='';
  orders.forEach(function(o){
    var timeLabel=o.elapsedMin>=60?Math.floor(o.elapsedMin/60)+'s '+(o.elapsedMin%60)+'dk':o.elapsedMin+'dk';
    lhtml+='<div style="display:flex;justify-content:space-between;padding:6px 8px;font-size:13px;border-bottom:1px solid var(--border)">';
    lhtml+='<span><strong>#'+o.orderNumber+'</strong> · '+o.name+'</span>';
    lhtml+='<span style="color:var(--tx3)">'+timeLabel+' · '+o.email+'</span>';
    lhtml+='</div>';
  });
  list.innerHTML=lhtml;
  
  popup.style.display='flex';
  document.getElementById('popup-confirm').disabled=false;
  document.getElementById('popup-confirm').textContent='Gönder ('+orders.length+')';
}

function closeSendPopup(){
  document.getElementById('send-popup').style.display='none';
  SEND_QUEUE=[];SEND_CALLBACK=null;
}

async function confirmSendPopup(){
  var btn=document.getElementById('popup-confirm');
  btn.disabled=true;
  var results=[];
  for(var i=0;i<SEND_QUEUE.length;i++){
    var o=SEND_QUEUE[i];
    btn.textContent='Gönderiliyor... ('+(i+1)+'/'+SEND_QUEUE.length+')';
    log('log-payment','Gönderiliyor: #'+o.orderNumber+' · '+o.name,'info');
    var res=await gasPost({action:'kargoSendReminder',pin:SESSION_PIN,orderId:String(o.id)});
    results.push(res);
    if(res.ok){
      log('log-payment','✓ '+res.message,'ok');
    }else{
      log('log-payment','✗ #'+o.orderNumber+' — '+(res.error||'Hata'),'err');
    }
  }
  if(SEND_CALLBACK)SEND_CALLBACK(results);
  btn.textContent='Tamamlandı';
  setTimeout(closeSendPopup,1500);
}

// === TESLİM LİSTESİ HATIRLATICI (17:15 - 17:40) ===
var teslimDismissed=false;
function teslimDismiss(){
  teslimDismissed=true;
  document.getElementById('teslim-overlay').style.display='none';
  document.getElementById('teslim-mini').style.display='flex';
}
function checkTeslimTime(){
  if(!SESSION_PIN)return;
  var now=new Date();
  var mins=now.getHours()*60+now.getMinutes();
  var overlay=document.getElementById('teslim-overlay');
  var mini=document.getElementById('teslim-mini');
  // 17:15 = 1035, 17:40 = 1060
  if(mins>=1035&&mins<=1060){
    if(!teslimDismissed){
      overlay.style.display='flex';
      mini.style.display='none';
    }else{
      overlay.style.display='none';
      mini.style.display='flex';
    }
    if(!window._teslimTitleBlink){
      window._teslimTitleBlink=setInterval(function(){
        document.title=document.title==='⚠️ TESLİM LİSTESİ!'?'Manhattan Kargo':'⚠️ TESLİM LİSTESİ!';
      },1000);
    }
  }else{
    overlay.style.display='none';
    mini.style.display='none';
    teslimDismissed=false;
    if(window._teslimTitleBlink){clearInterval(window._teslimTitleBlink);window._teslimTitleBlink=null;document.title='Manhattan Kargo'}
  }
}
setInterval(checkTeslimTime,30000);
// === OTOMATİK HATIRLATMA ===
var AUTO_THRESHOLD=45;

async function checkAutoStatus(){
  try{
    var res=await gasPost({action:'kargoGetAutoReminderStatus',pin:SESSION_PIN});
    if(res.ok){
      var tog=document.getElementById('auto-toggle');
      var txt=document.getElementById('auto-status-text');
      var box=document.getElementById('auto-reminder-box');
      tog.checked=res.enabled;
      if(res.threshold) {
        AUTO_THRESHOLD=res.threshold;
        document.getElementById('threshold-val').textContent=res.threshold;
      }
      if(res.enabled){
        txt.textContent='AKTİF';txt.style.color='var(--green)';
        box.style.borderColor='var(--green)';
      }else{
        txt.textContent='KAPALI';txt.style.color='var(--tx3)';
        box.style.borderColor='var(--border)';
      }
    }
  }catch(e){}
}

async function toggleAutoReminder(enabled){
  var txt=document.getElementById('auto-status-text');
  var box=document.getElementById('auto-reminder-box');
  txt.textContent='Kaydediliyor...';txt.style.color='var(--gold)';
  
  var res=await gasPost({action:'kargoToggleAutoReminder',pin:SESSION_PIN,enabled:enabled,threshold:AUTO_THRESHOLD});
  
  if(res.ok){
    if(res.enabled){
      txt.textContent='AKTİF';txt.style.color='var(--green)';
      box.style.borderColor='var(--green)';
      log('log-payment','Otomatik hatırlatma AKTİF. Bekleme: '+AUTO_THRESHOLD+' dk. Hafta içi 10:00-17:15.','ok');
    }else{
      txt.textContent='KAPALI';txt.style.color='var(--tx3)';
      box.style.borderColor='var(--border)';
      log('log-payment','Otomatik hatırlatma KAPATILDI.','skip');
    }
  }else{
    txt.textContent='HATA';txt.style.color='var(--red)';
    document.getElementById('auto-toggle').checked=!enabled;
    log('log-payment','Ayar kaydedilemedi.','err');
  }
}

function adjustThreshold(delta){
  AUTO_THRESHOLD=Math.max(15,Math.min(180,AUTO_THRESHOLD+delta));
  document.getElementById('threshold-val').textContent=AUTO_THRESHOLD;
}

async function saveThreshold(){
  var btn=document.getElementById('btn-save-threshold');
  btn.textContent='Kaydediliyor...';btn.disabled=true;
  var res=await gasPost({action:'kargoSaveThreshold',pin:SESSION_PIN,threshold:AUTO_THRESHOLD});
  if(res.ok){
    btn.textContent='Kaydedildi';btn.style.color='var(--green)';
    log('log-payment','Bekleme süresi '+AUTO_THRESHOLD+' dakika olarak kaydedildi.','ok');
  }else{
    btn.textContent='Hata';btn.style.color='var(--red)';
  }
  setTimeout(function(){btn.textContent='Kaydet';btn.style.color='';btn.disabled=false},2000);
}

async function testAutoReminder(){
  var btn=document.getElementById('btn-test-auto');
  var result=document.getElementById('test-result');
  btn.disabled=true;btn.textContent='Test ediliyor...';
  result.style.display='block';result.innerHTML='<p style="color:var(--gold);font-weight:600">Kontrol ediliyor...</p>';
  
  var res=await gasPost({action:'kargoTestAutoReminder',pin:SESSION_PIN,threshold:AUTO_THRESHOLD});
  
  if(res.ok){
    var html='<p style="margin:0 0 10px;font-size:16px;font-weight:700;color:var(--tx)">Test Sonucu (mail gönderilmedi)</p>';
    html+='<p style="margin:0 0 6px;font-size:14px;color:var(--tx2)">Sunucu saati: <strong>'+res.serverTime+'</strong></p>';
    html+='<p style="margin:0 0 6px;font-size:14px;color:var(--tx2)">Çalışma penceresi: <strong>'+(res.inWindow?'EVET (10:00-17:15 hafta içi)':'HAYIR — şu an gönderim yapılmaz')+'</strong></p>';
    html+='<p style="margin:0 0 6px;font-size:14px;color:var(--tx2)">Bekleme süresi: <strong>'+AUTO_THRESHOLD+' dk</strong></p>';
    html+='<p style="margin:0 0 10px;font-size:14px;color:var(--tx2)">Toplam ödeme bekleyen: <strong>'+res.totalUnpaid+'</strong></p>';
    
    if(res.wouldSend&&res.wouldSend.length>0){
      html+='<p style="margin:0 0 6px;font-size:15px;font-weight:700;color:var(--green)">Mail gönderilecek ('+res.wouldSend.length+'):</p>';
      res.wouldSend.forEach(function(o){
        html+='<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:14px"><strong style="color:var(--gold)">#'+o.orderNumber+'</strong> <strong>'+o.name+'</strong> · '+o.email+' · <span style="color:var(--red)">'+o.elapsedMin+' dk</span></div>';
      });
    }else{
      html+='<p style="margin:0;font-size:15px;color:var(--tx3)">Şu an gönderilecek mail yok (tüm siparişlere gönderilmiş veya süre dolmamış).</p>';
    }
    
    if(res.alreadySent&&res.alreadySent.length>0){
      html+='<p style="margin:10px 0 6px;font-size:15px;font-weight:700;color:var(--tx3)">Zaten gönderilmiş ('+res.alreadySent.length+'):</p>';
      res.alreadySent.forEach(function(o){
        html+='<div style="padding:4px 0;font-size:13px;color:var(--tx3)"><strong>#'+o.orderNumber+'</strong> '+o.name+' · '+o.email+'</div>';
      });
    }
    
    if(res.notReady&&res.notReady.length>0){
      html+='<p style="margin:10px 0 6px;font-size:15px;font-weight:700;color:#f59e0b">Henüz süre dolmamış ('+res.notReady.length+'):</p>';
      res.notReady.forEach(function(o){
        html+='<div style="padding:4px 0;font-size:13px;color:var(--tx2)"><strong>#'+o.orderNumber+'</strong> '+o.name+' · '+o.elapsedMin+' dk geçmiş</div>';
      });
    }
    
    result.innerHTML=html;
  }else{
    result.innerHTML='<p style="color:var(--red)">Hata: '+(res.error||'Bilinmeyen')+'</p>';
  }
  btn.disabled=false;btn.textContent='Test Et (mail göndermeden kontrol et)';
}

setTimeout(checkTeslimTime,2000);

// Auto-focus PIN input
document.addEventListener("DOMContentLoaded",function(){document.getElementById("pin-input").focus()});
</script>
</body>
</html>
